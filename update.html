<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinanSync - Tabungan & Investasi</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        // These colors now reference CSS variables for dynamic theming
                        'current-bg-base': 'var(--color-bg-base)',
                        'current-bg-sidebar': 'var(--color-bg-sidebar)',
                        'current-bg-card': 'var(--color-bg-card)',
                        'current-bg-card-hover': 'var(--color-bg-card-hover)',
                        'current-text-primary': 'var(--color-text-primary)',
                        'current-text-secondary': 'var(--color-text-secondary)',
                        'current-text-tertiary': 'var(--color-text-tertiary)',
                        'current-accent-main': 'var(--color-accent-main)',
                        'current-accent-hover': 'var(--color-accent-hover)',
                        'current-accent-dark': 'var(--color-accent-dark)',
                        'current-card-border': 'var(--color-card-border)',
                        'current-shadow-card': 'var(--color-shadow-card)',
                        'current-thin-divider': 'var(--color-thin-divider)',
                        'current-input-bg': 'var(--color-input-bg)',
                        'current-input-text': 'var(--color-input-text)',

                        // Specific status colors (used directly or referenced)
                        'status-green': 'var(--color-green-status)',
                        'status-yellow': 'var(--color-yellow-status)',
                        'status-red': 'var(--color-red-status)',
                        'info-blue': 'var(--color-blue-info)',
                    },
                    keyframes: {
                        fadeInUp: {
                            '0%': { opacity: '0', transform: 'translateY(20px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        pulse: {
                            '0%': { transform: 'scale(1)', opacity: '1' },
                            '50%': { transform: 'scale(1.05)', opacity: '0.7' },
                            '100%': { transform: 'scale(1)', opacity: '1' },
                        },
                        spin: {
                            '0%': { transform: 'rotate(0deg)' },
                            '100%': { transform: 'rotate(360deg)' },
                        },
                        buttonHover: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-2px)' },
                        },
                        skeletonPulse: {
                            '0%, 100%': { opacity: 1 },
                            '50%': { opacity: 0.5 },
                        },
                        listItemEnter: {
                            '0%': { opacity: '0', transform: 'translateX(-20px)' },
                            '100%': { opacity: '1', transform: 'translateX(0)' },
                        },
                        glow: {
                            '0%, 100%': { boxShadow: '0 0 5px var(--color-accent-main-light)' },
                            '50%': { boxShadow: '0 0 15px var(--color-accent-main-strong)' },
                        },
                        dotFade: {
                            '0%, 100%': { opacity: 0.2 },
                            '50%': { opacity: 1 },
                        },
                        dotBounce: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-5px)' },
                        }
                    },
                    animation: {
                        fadeInUp: 'fadeInUp 0.5s ease-out forwards',
                        pulse: 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        spin: 'spin 1s linear infinite',
                        buttonHover: 'buttonHover 0.3s forwards',
                        skeletonPulse: 'skeletonPulse 1.5s ease-in-out infinite',
                        listItemEnter: 'listItemEnter 0.4s ease-out forwards',
                        glow: 'glow 1.5s ease-in-out infinite',
                        dotFade: 'dotFade 1.2s infinite ease-in-out',
                        dotBounce: 'dotBounce 0.6s infinite alternate ease-in-out'
                    },
                }
            }
        }
    </script>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Chart.js for Data Visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
    <style>
        /* CSS Variables for Theming */
        :root {
            /* Dark Theme Defaults */
            --color-bg-base: #000000;
            --color-bg-sidebar: #1a1a1a;
            --color-bg-card: rgba(45, 45, 45, 0.6);
            --color-bg-card-hover: rgba(45, 45, 45, 0.8);
            --color-text-primary: #ffffff;
            --color-text-secondary: #f5f5f5;
            --color-text-tertiary: #e5e5e5;
            --color-accent-main: #00ff88;
            --color-accent-hover: #22c55e;
            --color-accent-dark: #16a34a;
            --color-card-border: rgba(255, 255, 255, 0.1);
            --color-shadow-card: rgba(0, 0, 0, 0.37);
            --color-scroll-track: #1a1a1a;
            --color-scroll-thumb: #1a1a1a; /* Matches sidebar background */
            --color-thin-divider: rgba(255,255,255,0.08);
            --color-input-bg: #2d2d2d; /* primary-700 */
            --color-input-text: #ffffff;

            /* Specific accent colors for charts/status */
            --color-green-status: #22c55e;
            --color-yellow-status: #eab308;
            --color-red-status: #ef4444;
            --color-blue-info: #3b82f6;

            /* Glow colors */
            --color-accent-main-light: rgba(0,255,136,0.3);
            --color-accent-main-strong: rgba(0,255,136,0.7);
        }

        /* Light Theme Overrides */
        body.light-mode {
            --color-bg-base: #f5f5f5;
            --color-bg-sidebar: #e5e5e5;
            --color-bg-card: rgba(255, 255, 255, 0.8);
            --color-bg-card-hover: rgba(240, 240, 240, 0.9);
            --color-text-primary: #1a1a1a;
            --color-text-secondary: #2d2d2d;
            --color-text-tertiary: #4b5563;
            --color-accent-main: #16a34a;
            --color-accent-hover: #15803d;
            --color-accent-dark: #0f766e; /* Teal-ish for light mode dark accent */
            --color-card-border: rgba(0, 0, 0, 0.1);
            --color-shadow-card: rgba(0, 0, 0, 0.15);
            --color-scroll-track: #e5e5e5;
            --color-scroll-thumb: #e5e5e5; /* Matches sidebar background */
            --color-thin-divider: rgba(0,0,0,0.08);
            --color-input-bg: #ffffff;
            --color-input-text: #1a1a1a;

            /* Light mode specific status colors for better contrast */
            --color-green-status: #16a34a;
            --color-yellow-status: #d97706;
            --color-red-status: #dc2626;
            --color-blue-info: #2563eb;

            /* Glow colors for light mode */
            --color-accent-main-light: rgba(34,197,94,0.3);
            --color-accent-main-strong: rgba(34,197,94,0.7);
        }

        /* Base styles using CSS variables */
        body {
            background-color: var(--color-bg-base);
            color: var(--color-text-primary);
            transition: background-color 0.3s ease-in-out, color 0.3s ease-in-out;
        }
        .sidebar {
            background-color: var(--color-bg-sidebar);
        }
        .glass-card {
            background-color: var(--color-bg-card);
            border: 1px solid var(--color-card-border);
            box-shadow: 0 8px 32px 0 var(--color-shadow-card);
        }
        .dashboard-summary-card {
            background: var(--color-bg-card); /* Keep simple for dynamic hover */
        }
        .dashboard-summary-card:hover {
            background: var(--color-bg-card-hover);
            box-shadow: 0 15px 30px var(--color-shadow-card);
        }
        .thin-divider {
            background-color: var(--color-thin-divider);
        }
        ::-webkit-scrollbar-track {
            background: var(--color-scroll-track);
        }
        ::-webkit-scrollbar-thumb {
            background: var(--color-scroll-thumb);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--color-scroll-thumb);
        }


        /* Button base styles */
        button {
            transition: background-color 0.2s ease-in-out, transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        button:not(#sidebar-toggle-open):not(#sidebar-toggle-close):not(.nav-link):hover {
            animation: buttonHover 0.3s forwards;
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 10px 20px var(--color-accent-main-light);
        }
        .bg-accent-600 { background-color: var(--color-accent-hover); }
        .hover\:bg-accent-700:hover { background-color: var(--color-accent-dark); }
        .bg-primary-700 { background-color: var(--color-input-bg); }
        .hover\:bg-primary-600:hover { background-color: var(--color-bg-card-hover); }

        /* Input/Select/Textarea styles */
        input, select, textarea {
            background-color: var(--color-input-bg);
            color: var(--color-input-text);
            border-color: var(--color-card-border);
            transition: background-color 0.3s ease-in-out, color 0.3s ease-in-out, border-color 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            box-shadow: 0 0 0 3px var(--color-accent-main-light);
            border-color: var(--color-accent-main);
        }

        /* Text colors */
        .text-secondary-100 { color: var(--color-text-primary); }
        .text-secondary-200 { color: var(--color-text-secondary); }
        .text-secondary-300 { color: var(--color-text-tertiary); }
        .text-accent-500 { color: var(--color-accent-main); }

        /* Status colors */
        .text-green-400 { color: var(--color-green-status); }
        .text-yellow-500 { color: var(--color-yellow-status); }
        .text-red-400 { color: var(--color-red-status); }
        .text-blue-400 { color: var(--color-blue-info); }

        /* Financial Health Score Border Glow */
        .score-border-green { border: 2px solid var(--color-green-status); box-shadow: 0 0 10px rgba(34,197,94,0.5); }
        .score-border-yellow { border: 2px solid var(--color-yellow-status); box-shadow: 0 0 10px rgba(234,179,8,0.5); }
        .score-border-red { border: 2px solid var(--color-red-status); box-shadow: 0 0 10px rgba(239,68,68,0.5); }
        .score-border-default { border: 2px solid var(--color-card-border); }

        /* General CSS for scrollbar and responsive table behavior */
        .table-responsive {
            display: block;
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        .table-responsive table {
            width: 100%;
            min-width: 600px;
        }

        /* Sidebar nav link alignment */
        .nav-link {
            justify-content: flex-start;
            padding-right: 1rem;
        }
        .nav-link i {
            width: 1.5rem;
            text-align: center;
            margin-right: 1rem;
        }
        @media (min-width: 768px) {
            .group:not(:hover) .nav-link {
                justify-content: center;
                padding-left: 0.5rem;
                padding-right: 0.5rem;
            }
            .group:not(:hover) .nav-link i {
                margin-right: 0;
            }
            .group:not(:hover) .nav-link span {
                display: none;
            }
        }

        /* Main content dynamic adjustment */
        .main-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            min-height: 100%;
            padding: 1.5rem; /* Consistent padding, increased for visual space */
            transition: margin-left 0.3s ease-in-out; /* Smooth transition */
            margin-left: 0; /* Default for mobile/collapsed */
        }

        @media (min-width: 768px) {
            .main-content.sidebar-collapsed-margin {
                margin-left: 4rem; /* Width of collapsed sidebar */
            }
            .main-content.sidebar-expanded-margin {
                margin-left: 16rem; /* Width of expanded sidebar (w-64 = 16rem) */
            }
        }

        /* PIN Screen specific styles */
        .pin-digit-display {
            width: 4rem; /* Adjusted for better visual */
            height: 4rem;
            font-size: 2rem;
            text-align: center;
            margin: 0 0.25rem;
            border-radius: 0.5rem;
            border: 1px solid var(--color-card-border);
            background-color: var(--color-input-bg);
            color: var(--color-input-text);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            transition: background-color 0.2s, color 0.2s, border-color 0.2s, box-shadow 0.2s;
        }
        .pin-digit-display.active-digit {
            border-color: var(--color-accent-main);
            box-shadow: 0 0 0 2px var(--color-accent-main-light);
        }
        .pin-digit-display.error-state {
            border-color: var(--color-red-status);
            box-shadow: 0 0 0 2px rgba(239,68,68,0.5);
        }

        .keypad-button {
            background-color: var(--color-input-bg);
            color: var(--color-text-primary);
            border-radius: 0.75rem;
            padding: 1rem;
            font-size: 1.5rem;
            font-weight: bold;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-out;
            box-shadow: 0 2px 5px var(--color-shadow-card);
        }
        .keypad-button:hover {
            background-color: var(--color-bg-card-hover);
            transform: scale(1.02);
        }
        .keypad-button:active {
            transform: scale(0.98);
        }
        .keypad-button.action-btn {
            font-size: 1rem;
        }

        /* Adjust PIN screen for responsiveness */
        #pin-screen {
            padding: 1rem; /* Add some padding for smaller screens */
        }
        #pin-keypad {
            width: 100%;
            max-width: 320px; /* Limit max width for keypad */
            margin-left: auto;
            margin-right: auto;
        }
        @media (min-width: 768px) {
            #pin-screen-title {
                font-size: 3rem; /* Larger title for desktop */
            }
            .pin-digit-display {
                width: 5rem; /* Larger digits for desktop */
                height: 5rem;
                font-size: 2.5rem;
            }
            #pin-keypad {
                max-width: 384px; /* Slightly larger keypad for desktop (w-96) */
                gap: 1rem;
            }
            .keypad-button {
                padding: 1.25rem;
                font-size: 1.8rem;
            }
        }
    </style>
</head>
<body class="bg-current-bg-base text-current-text-primary font-sans antialiased min-h-screen flex flex-col">

    <!-- PIN Authentication / Setup Screen -->
    <div id="pin-screen" class="fixed inset-0 bg-current-bg-base flex items-center justify-center z-50 flex-col p-4">
        <h2 id="pin-screen-title" class="text-3xl md:text-4xl font-bold text-current-text-primary mb-6 md:mb-8 animate-fadeInUp text-center">Atur PIN Anda</h2>
        <div class="flex space-x-2 md:space-x-3 mb-6 md:mb-8" id="pin-input-display">
            <div class="pin-digit-display" data-index="0"></div>
            <div class="pin-digit-display" data-index="1"></div>
            <div class="pin-digit-display" data-index="2"></div>
            <div class="pin-digit-display" data-index="3"></div>
        </div>
        <p id="pin-message" class="text-status-red mt-4 text-center h-6"></p> <!-- Added height to prevent layout shift -->

        <div id="pin-keypad" class="grid grid-cols-3 gap-2 w-full max-w-xs md:max-w-sm mt-6 md:mt-8">
            <button class="keypad-button">1</button>
            <button class="keypad-button">2</button>
            <button class="keypad-button">3</button>
            <button class="keypad-button">4</button>
            <button class="keypad-button">5</button>
            <button class="keypad-button">6</button>
            <button class="keypad-button">7</button>
            <button class="keypad-button">8</button>
            <button class="keypad-button">9</button>
            <button class="keypad-button action-btn" id="pin-clear-button" aria-label="Hapus Digit"><i class="fas fa-backspace"></i></button>
            <button class="keypad-button">0</button>
            <button class="keypad-button action-btn" id="pin-show-hide-button" aria-label="Tampilkan PIN"><i class="fas fa-eye"></i></button>
        </div>
        
        <button id="pin-action-button" class="mt-8 bg-current-accent-hover hover:bg-current-accent-dark text-current-text-primary font-bold py-3 px-8 rounded-xl focus:outline-none focus:shadow-outline text-lg animate-pulse" aria-label="Lanjutkan">Lanjutkan</button>
        <button id="forgot-pin-button" class="mt-4 text-info-blue hover:text-info-blue text-sm hidden" aria-label="Lupa PIN?">Lupa PIN?</button>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-current-bg-base flex items-center justify-center z-50 transition-opacity duration-500 opacity-100">
        <div class="flex flex-col items-center">
            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-current-accent-main"></div>
            <p class="mt-4 text-xl text-current-accent-main animate-pulse">Memuat FinanSync...</p>
        </div>
    </div>

    <!-- Main Application Container -->
    <div id="app" class="flex flex-grow hidden">

        <!-- Sidebar Navigation -->
        <aside id="sidebar" class="sidebar fixed inset-y-0 left-0 bg-current-bg-sidebar w-64 md:w-16 md:hover:w-64 z-40 p-4 flex flex-col transition-all duration-300 ease-in-out shadow-lg transform -translate-x-full md:translate-x-0 group">
            <div class="flex items-center justify-between md:justify-center mb-8">
                <div class="flex items-center">
                    <i class="fas fa-wallet text-current-accent-main text-3xl mr-3"></i>
                    <h1 class="text-2xl font-bold text-current-text-primary hidden md:group-hover:block md:hidden">FinanSync</h1>
                </div>
                <button id="sidebar-toggle-close" class="md:hidden text-current-text-primary text-xl focus:outline-none" aria-label="Tutup Sidebar">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <nav class="flex-grow">
                <ul class="space-y-4">
                    <li>
                        <a href="#dashboard" class="nav-link flex items-center p-3 rounded-xl hover:bg-current-bg-card-hover transition-colors duration-200 glass-card" data-section="dashboard" aria-label="Dashboard">
                            <i class="fas fa-chart-line text-current-accent-main text-xl"></i>
                            <span class="text-lg font-medium">Dashboard</span>
                        </a>
                    </li>
                    <li>
                        <a href="#investments" class="nav-link flex items-center p-3 rounded-xl hover:bg-current-bg-card-hover transition-colors duration-200 glass-card" data-section="investments" aria-label="Investasi">
                            <i class="fas fa-money-bill-trend-up text-current-accent-main text-xl"></i>
                            <span class="text-lg font-medium">Investasi</span>
                        </a>
                    </li>
                    <li>
                        <a href="#savings" class="nav-link flex items-center p-3 rounded-xl hover:bg-current-bg-card-hover transition-colors duration-200 glass-card" data-section="savings" aria-label="Tabungan">
                            <i class="fas fa-piggy-bank text-current-accent-main text-xl"></i>
                            <span class="text-lg font-medium">Tabungan</span>
                        </a>
                    </li>
                    <li>
                        <a href="#transactions" class="nav-link flex items-center p-3 rounded-xl hover:bg-current-bg-card-hover transition-colors duration-200 glass-card" data-section="transactions" aria-label="Transaksi">
                            <i class="fas fa-exchange-alt text-current-accent-main text-xl"></i>
                            <span class="text-lg font-medium">Transaksi</span>
                        </a>
                    </li>
                    <li>
                        <a href="#budget" class="nav-link flex items-center p-3 rounded-xl hover:bg-current-bg-card-hover transition-colors duration-200 glass-card" data-section="budget" aria-label="Anggaran">
                            <i class="fas fa-money-check-dollar text-current-accent-main text-xl"></i>
                            <span class="text-lg font-medium">Anggaran</span>
                        </a>
                    </li>
                     <li>
                        <a href="#bills" class="nav-link flex items-center p-3 rounded-xl hover:bg-current-bg-card-hover transition-colors duration-200 glass-card" data-section="bills" aria-label="Tagihan">
                            <i class="fas fa-receipt text-current-accent-main text-xl"></i>
                            <span class="text-lg font-medium">Tagihan</span>
                        </a>
                    </li>
                    <li>
                        <a href="#debts" class="nav-link flex items-center p-3 rounded-xl hover:bg-current-bg-card-hover transition-colors duration-200 glass-card" data-section="debts" aria-label="Utang">
                            <i class="fas fa-hand-holding-dollar text-current-accent-main text-xl"></i>
                            <span class="text-lg font-medium">Utang</span>
                        </a>
                    </li>
                    <li>
                        <a href="#tools" class="nav-link flex items-center p-3 rounded-xl hover:bg-current-bg-card-hover transition-colors duration-200 glass-card" data-section="tools" aria-label="Alat Keuangan">
                            <i class="fas fa-tools text-current-accent-main text-xl"></i>
                            <span class="text-lg font-medium">Alat</span>
                        </a>
                    </li>
                </ul>
            </nav>

            <!-- Footer for sidebar - Placeholder for user/version info -->
            <div class="mt-auto pt-4 border-t border-current-thin-divider text-sm text-current-text-tertiary text-center hidden md:group-hover:block md:hidden">
                FinanSync v1.8
            </div>
        </aside>

        <!-- Main Content Area -->
        <main id="main-content" class="main-content flex-grow flex flex-col p-4 md:p-8">
            <!-- Header for Mobile & Desktop -->
            <header class="flex items-center justify-between mb-6 pb-4 border-b border-current-thin-divider">
                <button id="sidebar-toggle-open" class="md:hidden text-current-text-primary text-2xl focus:outline-none" aria-label="Buka Sidebar">
                    <i class="fas fa-bars"></i>
                </button>
                <h2 id="page-title" class="text-3xl font-bold text-current-text-primary flex-grow text-center md:text-left">Dashboard</h2>
                <div class="flex items-center space-x-4">
                    <!-- Settings button added to header -->
                    <button id="settings-button" class="w-10 h-10 bg-current-input-bg rounded-full flex items-center justify-center text-current-text-primary font-semibold cursor-pointer transform hover:scale-105 transition-transform duration-200" aria-label="Pengaturan">
                        <i class="fas fa-cog text-xl"></i>
                    </button>
                    <button id="profile-avatar" class="w-10 h-10 bg-current-accent-hover rounded-full flex items-center justify-center text-current-text-primary font-semibold cursor-pointer transform hover:scale-105 transition-transform duration-200 overflow-hidden" aria-label="Profil Pengguna">
                        <img id="profile-photo" src="" alt="Foto Profil" class="w-full h-full object-cover hidden">
                        <span id="profile-initials">AB</span>
                    </button>
                </div>
            </header>

            <!-- Section Content -->
            <section id="dashboard-section" class="section-content animate-fadeInUp active-section flex flex-col space-y-8">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Card Total Investasi -->
                    <div class="glass-card p-6 rounded-xl shadow-lg flex flex-col items-start dashboard-summary-card">
                        <p class="text-current-text-tertiary text-lg mb-2">Total Investasi</p>
                        <h3 id="total-investments" class="text-4xl font-bold text-current-accent-main">Rp 0</h3>
                        <p class="text-sm text-current-text-secondary mt-2 flex items-center">
                            <i class="fas fa-arrow-up status-green mr-1"></i>
                            <span>+0%</span> (Hari Ini)
                        </p>
                    </div>
                    <!-- Card Total Tabungan -->
                    <div class="glass-card p-6 rounded-xl shadow-lg flex flex-col items-start dashboard-summary-card">
                        <p class="text-current-text-tertiary text-lg mb-2">Total Tabungan</p>
                        <h3 id="total-savings" class="text-4xl font-bold text-current-accent-main">Rp 0</h3>
                        <p class="text-sm text-current-text-secondary mt-2 flex items-center">
                            <i class="fas fa-arrow-up status-green mr-1"></i>
                            <span>+0%</span> (Bulan Ini)
                        </p>
                    </div>
                    <!-- Card Kekayaan Bersih -->
                    <div class="glass-card p-6 rounded-xl shadow-lg flex flex-col items-start dashboard-summary-card">
                        <p class="text-current-text-tertiary text-lg mb-2">Kekayaan Bersih</p>
                        <h3 id="net-worth" class="text-4xl font-bold text-current-accent-main">Rp 0</h3>
                        <p class="text-sm text-current-text-secondary mt-2 flex items-center">
                            <i class="fas fa-chart-simple info-blue mr-1"></i>
                            <span>Stabil</span> (Sejak Awal)
                        </p>
                    </div>
                </div>

                <!-- Financial Health Score -->
                <div id="financial-health-score-card" class="glass-card p-6 rounded-xl shadow-lg score-border-default transition-all duration-300">
                    <h4 class="text-xl font-semibold mb-4 text-current-text-primary">Skor Kesehatan Keuangan Anda</h4>
                    <div class="flex flex-col md:flex-row items-center justify-between space-y-4 md:space-y-0">
                        <div class="text-center md:text-left">
                            <p class="text-6xl font-bold text-current-accent-main transition-colors duration-300" id="financial-score">--</p>
                            <p class="text-lg text-current-text-secondary mt-2" id="financial-assessment">Tidak ada data untuk dinilai.</p>
                        </div>
                        <div class="text-sm text-current-text-tertiary space-y-1">
                            <p><i class="fas fa-circle-info mr-2"></i>Didasarkan pada rasio utang-aset dan tingkat tabungan.</p>
                            <p><i class="fas fa-circle-info mr-2"></i>Tambahkan lebih banyak data untuk skor yang lebih akurat.</p>
                        </div>
                    </div>
                </div>

                <div class="thin-divider"></div> <!-- Divider -->

                <!-- Data Visualizations -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Bagan Alokasi Aset -->
                    <div class="glass-card p-6 rounded-xl shadow-lg">
                        <h4 class="text-xl font-semibold mb-4 text-current-text-primary">Alokasi Aset</h4>
                        <div class="relative h-64">
                            <canvas id="assetAllocationChart"></canvas>
                            <div id="asset-allocation-skeleton" class="absolute inset-0 flex items-center justify-center bg-current-bg-sidebar rounded-xl skeleton hidden">
                                <i class="fas fa-chart-pie text-current-accent-main text-5xl"></i>
                            </div>
                        </div>
                    </div>
                    <!-- Analisis Arus Kas -->
                    <div class="glass-card p-6 rounded-xl shadow-lg">
                        <h4 class="text-xl font-semibold mb-4 text-current-text-primary">Analisis Arus Kas</h4>
                        <div class="relative h-64">
                            <canvas id="cashflowChart"></canvas>
                             <div id="cashflow-skeleton" class="absolute inset-0 flex items-center justify-center bg-current-bg-sidebar rounded-xl skeleton hidden">
                                <i class="fas fa-chart-bar text-current-accent-main text-5xl"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="investments-section" class="section-content animate-fadeInUp hidden">
                <h3 class="text-2xl font-bold mb-6 text-current-text-primary">Manajemen Aset Investasi</h3>
                <div class="glass-card p-6 rounded-xl shadow-lg mb-6">
                    <form id="add-investment-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="asset-name" class="block text-current-text-secondary text-sm font-bold mb-2">Nama Aset</label>
                            <input type="text" id="asset-name" name="name" class="shadow appearance-none border rounded-xl w-full py-2 px-3 bg-current-input-bg text-current-input-text leading-tight" placeholder="Contoh: Bitcoin, Saham BBCA" required>
                        </div>
                        <div>
                            <label for="asset-type" class="block text-current-text-secondary text-sm font-bold mb-2">Jenis Aset</label>
                            <select id="asset-type" name="type" class="shadow border rounded-xl w-full py-2 px-3 bg-current-input-bg text-current-input-text leading-tight" required>
                                <option value="Kripto">Kripto</option>
                                <option value="Saham">Saham</option>
                                <option value="Emas">Emas</option>
                                <option value="Reksadana">Reksadana</option>
                                <option value="Obligasi">Obligasi</option>
                                <option value="Properti">Properti</option>
                                <option value="Custom">Lainnya (Kustom)</option>
                            </select>
                        </div>
                        <div>
                            <label for="asset-value" class="block text-current-text-secondary text-sm font-bold mb-2">Nilai Akuisisi (IDR)</label>
                            <input type="number" id="asset-value" name="value" class="shadow appearance-none border rounded-xl w-full py-2 px-3 bg-current-input-bg text-current-input-text leading-tight" placeholder="Nilai saat dibeli" step="0.01" min="0" required>
                        </div>
                        <div id="asset-price-per-unit-group" class="hidden">
                            <label for="asset-price-per-unit" class="block text-current-text-secondary text-sm font-bold mb-2">Harga per Unit (IDR)</label>
                            <input type="number" id="asset-price-per-unit" name="pricePerUnit" class="shadow appearance-none border rounded-xl w-full py-2 px-3 bg-current-input-bg text-current-input-text leading-tight" placeholder="Harga 1 unit kripto" step="0.00000001" min="0">
                        </div>
                        <div>
                            <label for="asset-amount" class="block text-current-text-secondary text-sm font-bold mb-2">Jumlah</label>
                            <input type="number" id="asset-amount" name="amount" class="shadow appearance-none border rounded-xl w-full py-2 px-3 bg-current-input-bg text-current-input-text leading-tight" placeholder="Jumlah unit/lot" step="any" min="0" required>
                        </div>
                        <div class="col-span-1 md:col-span-2 flex justify-end">
                            <button type="submit" class="bg-current-accent-hover hover:bg-current-accent-dark text-current-text-primary font-bold py-2 px-6 rounded-xl focus:outline-none focus:shadow-outline flex items-center" aria-label="Tambah Aset">
                                <i class="fas fa-plus-circle mr-2"></i> Tambah Aset
                            </button>
                        </div>
                    </form>
                </div>

                <div class="glass-card p-6 rounded-xl shadow-lg">
                    <h4 class="text-xl font-semibold mb-4 text-current-text-primary">Daftar Investasi Anda</h4>
                    <div class="overflow-x-auto table-responsive">
                        <table class="min-w-full divide-y divide-current-thin-divider">
                            <thead class="bg-current-bg-sidebar">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-current-text-tertiary uppercase tracking-wider rounded-tl-lg">Nama</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-current-text-tertiary uppercase tracking-wider">Jenis</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-current-text-tertiary uppercase tracking-wider">Jumlah</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-current-text-tertiary uppercase tracking-wider">Nilai Akuisisi</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-current-text-tertiary uppercase tracking-wider">Nilai Saat Ini</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-current-text-tertiary uppercase tracking-wider rounded-tr-lg">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="investments-list" class="bg-current-bg-sidebar divide-y divide-current-thin-divider">
                                <!-- Investment items will be rendered here by JavaScript -->
                                <!-- Skeleton Loader -->
                                <tr class="skeleton-row">
                                    <td class="px-6 py-4"><div class="h-4 w-3/4 skeleton"></div></td>
                                    <td class="px-6 py-4"><div class="h-4 w-1/2 skeleton"></div></td>
                                    <td class="px-6 py-4"><div class="h-4 w-1/3 skeleton"></div></td>
                                    <td class="px-6 py-4"><div class="h-4 w-2/3 skeleton"></div></td>
                                    <td class="px-6 py-4"><div class="h-4 w-1/2 skeleton"></div></td>
                                    <td class="px-6 py-4"><div class="h-4 w-1/4 skeleton"></div></td>
                                </tr>
                                <tr class="skeleton-row">
                                    <td class="px-6 py-4"><div class="h-4 w-2/3 skeleton"></div></td>
                                    <td class="px-6 py-4"><div class="h-4 w-3/4 skeleton"></div></td>
                                    <td class="px-6 py-4"><div class="h-4 w-1/2 skeleton"></div></td>
                                    <td class="px-6 py-4"><div class="h-4 w-1/3 skeleton"></div></td>
                                    <td class="px-6 py-4"><div class="h-4 w-2/3 skeleton"></div></td>
                                    <td class="px-6 py-4"><div class="h-4 w-1/4 skeleton"></div></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="savings-section" class="section-content animate-fadeInUp hidden">
                <h3 class="text-2xl font-bold mb-6 text-current-text-primary">Sistem Tabungan</h3>
                <div class="glass-card p-6 rounded-xl shadow-lg mb-6">
                    <form id="add-saving-goal-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="goal-name" class="block text-current-text-secondary text-sm font-bold mb-2">Nama Target Tabungan</label>
                            <input type="text" id="goal-name" name="name" class="shadow appearance-none border rounded-xl w-full py-2 px-3 bg-current-input-bg text-current-input-text leading-tight" placeholder="Contoh: Dana Darurat, Liburan Bali" required>
                        </div>
                        <div>
                            <label for="goal-amount" class="block text-current-text-secondary text-sm font-bold mb-2">Target Jumlah (IDR)</label>
                            <input type="number" id="goal-amount" name="amount" class="shadow appearance-none border rounded-xl w-full py-2 px-3 bg-current-input-bg text-current-input-text leading-tight" placeholder="Target jumlah yang ingin dicapai" step="0.01" min="0" required>
                        </div>
                        <div class="col-span-1 md:col-span-2 flex justify-end">
                            <button type="submit" class="bg-current-accent-hover hover:bg-current-accent-dark text-current-text-primary font-bold py-2 px-6 rounded-xl focus:outline-none focus:shadow-outline flex items-center" aria-label="Tetapkan Target Tabungan">
                                <i class="fas fa-bullseye mr-2"></i> Tetapkan Target
                            </button>
                        </div>
                    </form>
                </div>

                <div class="glass-card p-6 rounded-xl shadow-lg mb-6">
                    <h4 class="text-xl font-semibold mb-4 text-current-text-primary">Tabungan Uang & Emas</h4>
                    <div id="currency-savings-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- Only IDR is here by default. Other currencies are dynamic. -->
                        <div class="glass-card p-4 rounded-xl flex flex-col items-start">
                            <p class="text-current-text-tertiary text-lg mb-1">Tabungan Uang (IDR)</p>
                            <h3 id="current-idr-savings" class="text-3xl font-bold text-current-accent-main">Rp 0</h3>
                            <button data-currency="IDR" class="add-funds-btn mt-2 bg-current-input-bg hover:bg-current-bg-card-hover text-current-text-primary text-sm py-1 px-3 rounded-lg focus:outline-none" aria-label="Tambah Dana IDR">Tambah Dana</button>
                        </div>
                        <!-- Gold Savings remains static -->
                        <div class="glass-card p-4 rounded-xl flex flex-col items-start">
                            <p class="text-current-text-tertiary text-lg mb-1">Tabungan Emas (gram)</p>
                            <h3 id="current-gold-savings" class="text-3xl font-bold text-current-accent-main">0 gram</h3>
                            <button data-currency="GOLD" class="add-funds-btn mt-2 bg-current-input-bg hover:bg-current-bg-card-hover text-current-text-primary text-sm py-1 px-3 rounded-lg focus:outline-none" aria-label="Tambah Emas">Tambah Emas</button>
                        </div>
                    </div>
                </div>

                <div class="glass-card p-6 rounded-xl shadow-lg">
                    <h4 class="text-xl font-semibold mb-4 text-current-text-primary">Target Tabungan Anda</h4>
                    <div id="saving-goals-list" class="space-y-4 relative">
                        <!-- Saving goals will be rendered here by JavaScript -->
                        <!-- Skeleton Loader -->
                         <div class="flex items-center justify-between p-4 glass-card rounded-xl skeleton-row">
                            <div class="flex-grow space-y-2">
                                <div class="h-6 w-3/4 skeleton"></div>
                                <div class="h-4 w-1/2 skeleton"></div>
                            </div>
                            <div class="w-24 h-2.5 skeleton"></div>
                        </div>
                        <div class="flex items-center justify-between p-4 glass-card rounded-xl skeleton-row">
                            <div class="flex-grow space-y-2">
                                <div class="h-6 w-2/3 skeleton"></div>
                                <div class="h-4 w-3/4 skeleton"></div>
                            </div>
                            <div class="w-24 h-2.5 skeleton"></div>
                        </div>
                    </div>

                    <div class="thin-divider"></div> <!-- Divider -->

                    <h4 class="text-xl font-semibold mb-4 mt-8 text-current-text-primary">Dana Darurat</h4>
                    <div class="glass-card p-4 rounded-xl flex items-center justify-between shadow-md">
                        <div>
                            <p class="text-lg font-semibold text-current-text-primary">Status Dana Darurat</p>
                            <p class="text-sm text-current-text-secondary">Target: <span id="emergency-fund-target">Rp 0</span></p>
                            <p class="text-sm text-current-text-secondary">Saat Ini: <span id="emergency-fund-current">Rp 0</span></p>
                        </div>
                        <div class="flex flex-col items-end space-y-2">
                            <div class="w-24 bg-current-input-bg rounded-full h-2.5">
                                <div id="emergency-fund-progress-bar" class="bg-current-accent-main h-2.5 rounded-full" style="width: 0%"></div>
                            </div>
                            <span id="emergency-fund-percentage" class="text-sm font-medium text-current-accent-main">0.00%</span>
                            <button id="set-emergency-fund-btn" class="bg-current-input-bg hover:bg-current-bg-card-hover text-current-text-primary text-sm py-1 px-3 rounded-lg focus:outline-none" aria-label="Atur Target Dana Darurat">Atur Target</button>
                        </div>
                    </div>
                </div>
            </section>

            <section id="transactions-section" class="section-content animate-fadeInUp hidden">
                <h3 class="text-2xl font-bold mb-6 text-current-text-primary">Manajemen Keuangan - Transaksi</h3>
                <div class="glass-card p-6 rounded-xl shadow-lg mb-6">
                    <form id="add-transaction-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="transaction-type" class="block text-current-text-secondary text-sm font-bold mb-2">Jenis Transaksi</label>
                            <select id="transaction-type" name="type" class="shadow appearance-none border rounded-xl w-full py-2 px-3 bg-current-input-bg text-current-input-text leading-tight" required>
                                <option value="income">Pemasukan</option>
                                <option value="expense">Pengeluaran</option>
                            </select>
                        </div>
                        <div>
                            <label for="transaction-category" class="block text-current-text-secondary text-sm font-bold mb-2">Kategori</label>
                            <input type="text" id="transaction-category" name="category" class="shadow appearance-none border rounded-xl w-full py-2 px-3 bg-current-input-bg text-current-input-text leading-tight" placeholder="Contoh: Gaji, Makanan, Transportasi" required>
                        </div>
                        <div>
                            <label for="transaction-amount" class="block text-current-text-secondary text-sm font-bold mb-2">Jumlah (IDR)</label>
                            <input type="number" id="transaction-amount" name="amount" class="shadow appearance-none border rounded-xl w-full py-2 px-3 bg-current-input-bg text-current-input-text leading-tight" placeholder="Jumlah transaksi" step="0.01" min="0" required>
                        </div>
                        <div>
                            <label for="transaction-date" class="block text-current-text-secondary text-sm font-bold mb-2">Tanggal</label>
                            <input type="date" id="transaction-date" name="date" class="shadow appearance-none border rounded-xl w-full py-2 px-3 bg-current-input-bg text-current-input-text leading-tight" required>
                        </div>
                        <div>
                            <label for="transaction-description" class="block text-current-text-secondary text-sm font-bold mb-2">Deskripsi (Opsional)</label>
                            <textarea id="transaction-description" name="description" class="shadow appearance-none border rounded-xl w-full py-2 px-3 bg-current-input-bg text-current-input-text leading-tight" placeholder="Detail transaksi"></textarea>
                        </div>
                        <div class="col-span-1 md:col-span-2 flex justify-end">
                            <button type="submit" class="bg-current-accent-hover hover:bg-current-accent-dark text-current-text-primary font-bold py-2 px-6 rounded-xl focus:outline-none focus:shadow-outline flex items-center" aria-label="Tambah Transaksi">
                                <i class="fas fa-plus-circle mr-2"></i> Tambah Transaksi
                            </button>
                        </div>
                    </form>
                </div>

                <div class="glass-card p-6 rounded-xl shadow-lg">
                    <h4 class="text-xl font-semibold mb-4 text-current-text-primary">Riwayat Transaksi</h4>
                    <div class="flex flex-col md:flex-row md:items-center justify-between mb-4 space-y-2 md:space-y-0 md:space-x-4">
                        <div class="flex items-center space-x-2">
                            <label for="filter-time" class="text-current-text-secondary">Tampilkan:</label>
                            <select id="filter-time" class="shadow appearance-none border rounded-xl py-1 px-2 bg-current-input-bg text-current-input-text leading-tight" aria-label="Filter Waktu Transaksi">
                                <option value="all">Semua</option>
                                <option value="week">Minggu Ini</option>
                                <option value="month">Bulan Ini</option>
                                <option value="year">Tahun Ini</option>
                            </select>
                        </div>
                        <div class="flex items-center space-x-2">
                            <label for="filter-type" class="text-current-text-secondary">Jenis:</label>
                            <select id="filter-type" class="shadow appearance-none border rounded-xl py-1 px-2 bg-current-input-bg text-current-input-text leading-tight" aria-label="Filter Jenis Transaksi">
                                <option value="all">Semua</option>
                                <option value="income">Pemasukan</option>
                                <option value="expense">Pengeluaran</option>
                            </select>
                        </div>
                    </div>
                    <div class="overflow-x-auto table-responsive">
                        <table class="min-w-full divide-y divide-current-thin-divider">
                            <thead class="bg-current-bg-sidebar">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-current-text-tertiary uppercase tracking-wider rounded-tl-lg">Tanggal</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-current-text-tertiary uppercase tracking-wider">Jenis</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-current-text-tertiary uppercase tracking-wider">Kategori</th>
                                    <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-current-text-tertiary uppercase tracking-wider">Jumlah</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-current-text-tertiary uppercase tracking-wider">Deskripsi</th>
                                    <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-current-text-tertiary uppercase tracking-wider">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="transactions-list" class="bg-current-bg-sidebar divide-y divide-current-thin-divider">
                                <!-- Transaction items will be rendered here by JavaScript -->
                                <!-- Skeleton Loader -->
                                <tr class="skeleton-row">
                                    <td class="px-6 py-4"><div class="h-4 w-1/3 skeleton"></div></td>
                                    <td class="px-6 py-4"><div class="h-4 w-1/4 skeleton"></div></td>
                                    <td class="px-6 py-4"><div class="h-4 w-1/2 skeleton"></div></td>
                                    <td class="px-6 py-4"><div class="h-4 w-1/3 skeleton"></div></td>
                                    <td class="px-6 py-4"><div class="h-4 w-3/4 skeleton"></div></td>
                                    <td class="px-6 py-4"><div class="h-4 w-1/4 skeleton"></div></td>
                                </tr>
                                <tr class="skeleton-row">
                                    <td class="px-6 py-4"><div class="h-4 w-1/2 skeleton"></div></td>
                                    <td class="px-6 py-4"><div class="h-4 w-1/3 skeleton"></div></td>
                                    <td class="px-6 py-4"><div class="h-4 w-3/4 skeleton"></div></td>
                                    <td class="px-6 py-4"><div class="h-4 w-1/2 skeleton"></div></td>
                                    <td class="px-6 py-4"><div class="h-4 w-1/3 skeleton"></div></td>
                                    <td class="px-6 py-4"><div class="h-4 w-1/4 skeleton"></div></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="budget-section" class="section-content animate-fadeInUp hidden">
                <h3 class="text-2xl font-bold mb-6 text-current-text-primary">Perencana Anggaran Bulanan</h3>
                <div class="glass-card p-6 rounded-xl shadow-lg mb-6">
                    <form id="set-budget-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="budget-month" class="block text-current-text-secondary text-sm font-bold mb-2">Bulan & Tahun</label>
                            <input type="month" id="budget-month" name="month" class="shadow appearance-none border rounded-xl w-full py-2 px-3 bg-current-input-bg text-current-input-text leading-tight" required>
                        </div>
                        <div>
                            <label for="budget-amount" class="block text-current-text-secondary text-sm font-bold mb-2">Jumlah Anggaran (IDR)</label>
                            <input type="number" id="budget-amount" name="amount" class="shadow appearance-none border rounded-xl w-full py-2 px-3 bg-current-input-bg text-current-input-text leading-tight" placeholder="Contoh: 5000000" step="0.01" min="0" required>
                        </div>
                        <div class="col-span-1 md:col-span-2 flex justify-end">
                            <button type="submit" class="bg-current-accent-hover hover:bg-current-accent-dark text-current-text-primary font-bold py-2 px-6 rounded-xl focus:outline-none focus:shadow-outline flex items-center" aria-label="Tetapkan Anggaran">
                                <i class="fas fa-plus-circle mr-2"></i> Tetapkan Anggaran
                            </button>
                        </div>
                    </form>
                </div>

                <div class="glass-card p-6 rounded-xl shadow-lg mb-6">
                    <h4 class="text-xl font-semibold mb-4 text-current-text-primary">Anggaran Bulan Ini</h4>
                    <div id="current-month-budget-summary" class="text-center text-current-text-tertiary">
                        <p>Belum ada anggaran yang ditetapkan untuk bulan ini.</p>
                    </div>
                </div>

                <div class="thin-divider"></div> <!-- Divider -->

                <div class="glass-card p-6 rounded-xl shadow-lg">
                    <h4 class="text-xl font-semibold mb-4 text-current-text-primary">Riwayat Anggaran Anda</h4>
                    <div id="budget-list" class="space-y-4">
                        <!-- Budgets will be rendered here by JavaScript -->
                        <p class="text-center text-current-text-tertiary">Belum ada anggaran yang ditetapkan.</p>
                    </div>
                </div>
            </section>

            <section id="bills-section" class="section-content animate-fadeInUp hidden">
                <h3 class="text-2xl font-bold mb-6 text-current-text-primary">Pengingat Tagihan</h3>
                <div class="glass-card p-6 rounded-xl shadow-lg mb-6">
                    <form id="add-bill-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="bill-name" class="block text-current-text-secondary text-sm font-bold mb-2">Nama Tagihan</label>
                            <input type="text" id="bill-name" name="name" class="shadow appearance-none border rounded-xl w-full py-2 px-3 bg-current-input-bg text-current-input-text leading-tight" placeholder="Contoh: Listrik, Internet" required>
                        </div>
                        <div>
                            <label for="bill-amount" class="block text-current-text-secondary text-sm font-bold mb-2">Jumlah Tagihan (IDR)</label>
                            <input type="number" id="bill-amount" name="amount" class="shadow appearance-none border rounded-xl w-full py-2 px-3 bg-current-input-bg text-current-input-text leading-tight" placeholder="Jumlah" step="0.01" min="0" required>
                        </div>
                        <div>
                            <label for="bill-due-date" class="block text-current-text-secondary text-sm font-bold mb-2">Tanggal Jatuh Tempo</label>
                            <input type="date" id="bill-due-date" name="dueDate" class="shadow appearance-none border rounded-xl w-full py-2 px-3 bg-current-input-bg text-current-input-text leading-tight" required>
                        </div>
                        <div>
                            <label for="bill-frequency" class="block text-current-text-secondary text-sm font-bold mb-2">Frekuensi</label>
                            <select id="bill-frequency" name="frequency" class="shadow appearance-none border rounded-xl w-full py-2 px-3 bg-current-input-bg text-current-input-text leading-tight" required>
                                <option value="monthly">Bulanan</option>
                                <option value="quarterly">Tiga Bulanan</option>
                                <option value="annually">Tahunan</option>
                                <option value="once">Satu Kali</option>
                            </select>
                        </div>
                        <div class="col-span-1 md:col-span-2 flex justify-end">
                            <button type="submit" class="bg-current-accent-hover hover:bg-current-accent-dark text-current-text-primary font-bold py-2 px-6 rounded-xl focus:outline-none focus:shadow-outline flex items-center" aria-label="Tambah Tagihan">
                                <i class="fas fa-plus-circle mr-2"></i> Tambah Tagihan
                            </button>
                        </div>
                    </form>
                </div>

                <div class="glass-card p-6 rounded-xl shadow-lg">
                    <h4 class="text-xl font-semibold mb-4 text-current-text-primary">Daftar Tagihan Anda</h4>
                     <div class="flex items-center space-x-2 mb-4">
                        <label for="filter-bills" class="text-current-text-secondary">Tampilkan:</label>
                        <select id="filter-bills" class="shadow appearance-none border rounded-xl py-1 px-2 bg-current-input-bg text-current-input-text leading-tight" aria-label="Filter Tagihan">
                            <option value="upcoming">Akan Datang</option>
                            <option value="all">Semua</option>
                        </select>
                    </div>
                    <div id="bills-list" class="space-y-4">
                        <!-- Bills will be rendered here by JavaScript -->
                        <p class="text-center text-current-text-tertiary">Belum ada tagihan yang ditambahkan.</p>
                    </div>
                </div>
            </section>

            <section id="debts-section" class="section-content animate-fadeInUp hidden">
                <h3 class="text-2xl font-bold mb-6 text-current-text-primary">Manajemen Utang</h3>
                <div class="glass-card p-6 rounded-xl shadow-lg mb-6">
                    <form id="add-debt-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="debt-name" class="block text-current-text-secondary text-sm font-bold mb-2">Nama Utang</label>
                            <input type="text" id="debt-name" name="name" class="shadow appearance-none border rounded-xl w-full py-2 px-3 bg-current-input-bg text-current-input-text leading-tight" placeholder="Contoh: Pinjaman Bank, Kartu Kredit" required>
                        </div>
                        <div>
                            <label for="debt-original-amount" class="block text-current-text-secondary text-sm font-bold mb-2">Jumlah Awal (IDR)</label>
                            <input type="number" id="debt-original-amount" name="originalAmount" class="shadow appearance-none border rounded-xl w-full py-2 px-3 bg-current-input-bg text-current-input-text leading-tight" placeholder="Jumlah utang awal" step="0.01" min="0" required>
                        </div>
                        <div>
                            <label for="debt-current-balance" class="block text-current-text-secondary text-sm font-bold mb-2">Saldo Saat Ini (IDR)</label>
                            <input type="number" id="debt-current-balance" name="currentBalance" class="shadow appearance-none border rounded-xl w-full py-2 px-3 bg-current-input-bg text-current-input-text leading-tight" placeholder="Saldo yang tersisa" step="0.01" min="0" required>
                        </div>
                        <div>
                            <label for="debt-interest-rate" class="block text-current-text-secondary text-sm font-bold mb-2">Suku Bunga Tahunan (%)</label>
                            <input type="number" id="debt-interest-rate" name="interestRate" class="shadow appearance-none border rounded-xl w-full py-2 px-3 bg-current-input-bg text-current-input-text leading-tight" placeholder="Contoh: 5.0" step="0.01" min="0" required>
                        </div>
                        <div class="col-span-1 md:col-span-2 flex justify-end">
                            <button type="submit" class="bg-current-accent-hover hover:bg-current-accent-dark text-current-text-primary font-bold py-2 px-6 rounded-xl focus:outline-none focus:shadow-outline flex items-center" aria-label="Tambah Utang">
                                <i class="fas fa-plus-circle mr-2"></i> Tambah Utang
                            </button>
                        </div>
                    </form>
                </div>

                <div class="glass-card p-6 rounded-xl shadow-lg">
                    <h4 class="text-xl font-semibold mb-4 text-current-text-primary">Daftar Utang Anda</h4>
                    <div class="overflow-x-auto table-responsive">
                        <table class="min-w-full divide-y divide-current-thin-divider">
                            <thead class="bg-current-bg-sidebar">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-current-text-tertiary uppercase tracking-wider rounded-tl-lg">Nama</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-current-text-tertiary uppercase tracking-wider">Jumlah Awal</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-current-text-tertiary uppercase tracking-wider">Saldo Saat Ini</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-current-text-tertiary uppercase tracking-wider">Bunga (%)</th>
                                    <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-current-text-tertiary uppercase tracking-wider rounded-tr-lg">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="debts-list" class="bg-current-bg-sidebar divide-y divide-current-thin-divider">
                                <!-- Debt items will be rendered here by JavaScript -->
                                <tr>
                                    <td colspan="5" class="px-6 py-4 whitespace-nowrap text-center text-current-text-tertiary">Belum ada utang yang ditambahkan.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="tools-section" class="section-content animate-fadeInUp hidden">
                <h3 class="text-2xl font-bold mb-6 text-current-text-primary">Alat Keuangan</h3>

                <!-- Compound Interest Calculator -->
                <div class="glass-card p-6 rounded-xl shadow-lg mb-6">
                    <h4 class="text-xl font-semibold mb-4 text-current-text-primary">Kalkulator Bunga Majemuk</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="principal" class="block text-current-text-secondary text-sm font-bold mb-2">Pokok Awal (IDR)</label>
                            <input type="number" id="principal" class="shadow appearance-none border rounded-xl w-full py-2 px-3 bg-current-input-bg text-current-input-text leading-tight" value="1000000" step="0.01" min="0" aria-label="Pokok Awal">
                        </div>
                        <div>
                            <label for="annual-rate" class="block text-current-text-secondary text-sm font-bold mb-2">Tingkat Bunga Tahunan (%)</label>
                            <input type="number" id="annual-rate" class="shadow appearance-none border rounded-xl w-full py-2 px-3 bg-current-input-bg text-current-input-text leading-tight" value="5" step="0.01" min="0" aria-label="Tingkat Bunga Tahunan">
                        </div>
                        <div>
                            <label for="years" class="block text-current-text-secondary text-sm font-bold mb-2">Jumlah Tahun</label>
                            <input type="number" id="years" class="shadow appearance-none border rounded-xl w-full py-2 px-3 bg-current-input-bg text-current-input-text leading-tight" value="10" min="0" aria-label="Jumlah Tahun">
                        </div>
                        <div>
                            <label for="compound-frequency" class="block text-current-text-secondary text-sm font-bold mb-2">Frekuensi Majemuk</label>
                            <select id="compound-frequency" class="shadow appearance-none border rounded-xl w-full py-2 px-3 bg-current-input-bg text-current-input-text leading-tight" aria-label="Frekuensi Majemuk">
                                <option value="1">Tahunan</option>
                                <option value="2">Setengah Tahunan</option>
                                <option value="4">Kuartalan</option>
                                <option value="12">Bulanan</option>
                                <option value="365">Harian</option>
                            </select>
                        </div>
                    </div>
                    <button id="calculate-compound-btn" class="mt-6 bg-current-accent-hover hover:bg-current-accent-dark text-current-text-primary font-bold py-2 px-6 rounded-xl focus:outline-none focus:shadow-outline flex items-center" aria-label="Hitung Bunga Majemuk">
                        <i class="fas fa-calculator mr-2"></i> Hitung Bunga Majemuk
                    </button>
                    <div class="mt-4 p-4 glass-card rounded-xl">
                        <p class="text-current-text-secondary">Jumlah Akhir: <span id="compound-result" class="text-current-accent-main font-bold">Rp 0</span></p>
                    </div>
                </div>

                <!-- Retirement Calculator -->
                <div class="glass-card p-6 rounded-xl shadow-lg mb-6">
                    <h4 class="text-xl font-semibold mb-4 text-current-text-primary">Kalkulator Pensiun</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="current-age" class="block text-current-text-secondary text-sm font-bold mb-2">Usia Saat Ini</label>
                            <input type="number" id="current-age" class="shadow appearance-none border rounded-xl w-full py-2 px-3 bg-current-input-bg text-current-input-text" value="30" min="0" aria-label="Usia Saat Ini">
                        </div>
                        <div>
                            <label for="retirement-age" class="block text-current-text-secondary text-sm font-bold mb-2">Usia Pensiun</label>
                            <input type="number" id="retirement-age" class="shadow appearance-none border rounded-xl w-full py-2 px-3 bg-current-input-bg text-current-input-text" value="65" min="0" aria-label="Usia Pensiun">
                        </div>
                        <div>
                            <label for="current-retirement-savings" class="block text-current-text-secondary text-sm font-bold mb-2">Tabungan Pensiun Saat Ini (IDR)</label>
                            <input type="number" id="current-retirement-savings" class="shadow appearance-none border rounded-xl w-full py-2 px-3 bg-current-input-bg text-current-input-text" value="10000000" step="0.01" min="0" aria-label="Tabungan Pensiun Saat Ini">
                        </div>
                        <div>
                            <label for="annual-contribution" class="block text-current-text-secondary text-sm font-bold mb-2">Kontribusi Tahunan (IDR)</label>
                            <input type="number" id="annual-contribution" class="shadow appearance-none border rounded-xl w-full py-2 px-3 bg-current-input-bg text-current-input-text" value="2000000" step="0.01" min="0" aria-label="Kontribusi Tahunan">
                        </div>
                        <div>
                            <label for="estimated-return" class="block text-current-text-secondary text-sm font-bold mb-2">Estimasi Tingkat Pengembalian Tahunan (%)</label>
                            <input type="number" id="estimated-return" class="shadow appearance-none border rounded-xl w-full py-2 px-3 bg-current-input-bg text-current-input-text" value="7" step="0.01" min="0" aria-label="Estimasi Tingkat Pengembalian">
                        </div>
                    </div>
                    <button id="calculate-retirement-btn" class="mt-6 bg-current-accent-hover hover:bg-current-accent-dark text-current-text-primary font-bold py-2 px-6 rounded-xl focus:outline-none focus:shadow-outline flex items-center" aria-label="Hitung Pensiun">
                        <i class="fas fa-person-walking-luggage mr-2"></i> Hitung Pensiun
                    </button>
                    <div class="mt-4 p-4 glass-card rounded-xl">
                        <p class="text-current-text-secondary">Estimasi Tabungan Saat Pensiun: <span id="retirement-result" class="text-current-accent-main font-bold">Rp 0</span></p>
                    </div>
                </div>

                <!-- Currency Converter -->
                <div class="glass-card p-6 rounded-xl shadow-lg mb-6">
                    <h4 class="text-xl font-semibold mb-4 text-current-text-primary">Konverter Mata Uang</h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="from-currency-amount" class="block text-current-text-secondary text-sm font-bold mb-2">Jumlah</label>
                            <input type="number" id="from-currency-amount" class="shadow appearance-none border rounded-xl w-full py-2 px-3 bg-current-input-bg text-current-input-text leading-tight" value="1" step="0.01" min="0" aria-label="Jumlah Konversi Asal">
                        </div>
                        <div>
                            <label for="from-currency" class="block text-current-text-secondary text-sm font-bold mb-2">Dari</label>
                            <select id="from-currency" class="shadow appearance-none border rounded-xl w-full py-2 px-3 bg-current-input-bg text-current-input-text leading-tight" aria-label="Mata Uang Asal">
                                <option value="IDR">IDR - Rupiah Indonesia</option>
                                <option value="USD">USD - Dolar Amerika</option>
                                <option value="EUR">EUR - Euro</option>
                            </select>
                        </div>
                        <div>
                            <label for="to-currency" class="block text-current-text-secondary text-sm font-bold mb-2">Ke</label>
                            <select id="to-currency" class="shadow appearance-none border rounded-xl w-full py-2 px-3 bg-current-input-bg text-current-input-text leading-tight" aria-label="Mata Uang Tujuan">
                                <option value="USD">USD - Dolar Amerika</option>
                                <option value="IDR">IDR - Rupiah Indonesia</option>
                                <option value="EUR">EUR - Euro</option>
                            </select>
                        </div>
                    </div>
                    <button id="convert-currency-btn" class="mt-6 bg-current-accent-hover hover:bg-current-accent-dark text-current-text-primary font-bold py-2 px-6 rounded-xl focus:outline-none focus:shadow-outline flex items-center" aria-label="Konversi Mata Uang">
                        <i class="fas fa-arrows-turn-to-dots mr-2"></i> Konversi
                    </button>
                    <div class="mt-4 p-4 glass-card rounded-xl">
                        <p class="text-current-text-secondary">Hasil Konversi: <span id="conversion-result" class="text-current-accent-main font-bold">0</span></p>
                        <p class="text-sm text-current-text-tertiary mt-2">Nilai tukar adalah hardcoded dan tidak real-time.</p>
                    </div>
                </div>

                <!-- Risk Calculator (Placeholder Enhanced) -->
                <div class="glass-card p-6 rounded-xl shadow-lg mb-6">
                    <h4 class="text-xl font-semibold mb-4 text-current-text-primary">Kalkulator Risiko Investasi (Simulasi)</h4>
                    <p class="text-current-text-secondary mb-4">Fitur ini mensimulasikan perhitungan profil risiko berdasarkan beberapa pertanyaan sederhana. Untuk hasil yang akurat, konsultasikan dengan perencana keuangan.</p>
                    <div class="space-y-4">
                        <div>
                            <label for="risk-q1" class="block text-current-text-secondary text-sm font-bold mb-2">Berapa lama horizon investasi Anda?</label>
                            <select id="risk-q1" class="shadow appearance-none border rounded-xl w-full py-2 px-3 bg-current-input-bg text-current-input-text leading-tight" aria-label="Pertanyaan Risiko 1">
                                <option value="1">Kurang dari 1 tahun</option>
                                <option value="3">1-3 tahun</option>
                                <option value="5">3-5 tahun</option>
                                <option value="10">Lebih dari 5 tahun</option>
                            </select>
                        </div>
                        <div>
                            <label for="risk-q2" class="block text-current-text-secondary text-sm font-bold mb-2">Bagaimana reaksi Anda terhadap penurunan nilai portofolio 20%?</label>
                            <select id="risk-q2" class="shadow appearance-none border rounded-xl w-full py-2 px-3 bg-current-input-bg text-current-input-text leading-tight" aria-label="Pertanyaan Risiko 2">
                                <option value="1">Panik dan jual semua</option>
                                <option value="2">Khawatir, tapi tetap tenang</option>
                                <option value="3">Melihatnya sebagai peluang untuk membeli lebih</option>
                            </select>
                        </div>
                    </div>
                    <button id="calculate-risk-btn" class="mt-6 bg-current-accent-hover hover:bg-current-accent-dark text-current-text-primary font-bold py-2 px-6 rounded-xl focus:outline-none focus:shadow-outline flex items-center" aria-label="Hitung Profil Risiko">
                        <i class="fas fa-user-shield mr-2"></i> Hitung Profil Risiko
                    </button>
                    <div class="mt-4 p-4 glass-card rounded-xl">
                        <p class="text-current-text-secondary">Profil Risiko Anda: <span id="risk-result" class="text-current-accent-main font-bold">Tidak Diketahui</span></p>
                    </div>
                </div>
            </section>

            <section id="settings-section" class="section-content animate-fadeInUp hidden">
                <h3 class="text-2xl font-bold mb-6 text-current-text-primary">Pengaturan Aplikasi</h3>
                <div class="glass-card p-6 rounded-xl shadow-lg space-y-6">
                    <div>
                        <h4 class="text-xl font-semibold mb-2 text-current-text-primary">Manajemen Data</h4>
                        <div class="flex flex-col md:flex-row space-y-3 md:space-y-0 md:space-x-4">
                            <button id="export-data-btn" class="bg-current-accent-hover hover:bg-current-accent-dark text-current-text-primary font-bold py-2 px-4 rounded-xl flex items-center justify-center" aria-label="Ekspor Data">
                                <i class="fas fa-file-export mr-2"></i> Ekspor Data (JSON)
                            </button>
                            <label for="import-file" class="bg-current-input-bg hover:bg-current-bg-card-hover text-current-text-secondary font-bold py-2 px-4 rounded-xl cursor-pointer flex items-center justify-center" aria-label="Impor Data">
                                <i class="fas fa-file-import mr-2"></i> Impor Data (JSON)
                                <input type="file" id="import-file" accept=".json" class="hidden">
                            </label>
                            <button id="backup-data-btn" class="bg-current-input-bg hover:bg-current-bg-card-hover text-current-text-secondary font-bold py-2 px-4 rounded-xl flex items-center justify-center" aria-label="Backup Otomatis (Simulasi)">
                                <i class="fas fa-cloud-upload-alt mr-2"></i> Backup Otomatis (Simulasi)
                            </button>
                        </div>
                    </div>

                    <div class="thin-divider"></div>

                    <div>
                        <h4 class="text-xl font-semibold mb-2 text-current-text-primary">Pengaturan Tabungan & Mata Uang</h4>
                        <button id="manage-currencies-btn" class="bg-current-input-bg hover:bg-current-bg-card-hover text-current-text-secondary font-bold py-2 px-4 rounded-xl focus:outline-none focus:shadow-outline flex items-center" aria-label="Kelola Mata Uang">
                            <i class="fas fa-coins mr-2"></i> Kelola Mata Uang
                        </button>
                    </div>

                    <div class="thin-divider"></div>

                    <div>
                        <h4 class="text-xl font-semibold mb-2 text-current-text-primary">PIN & Keamanan</h4>
                        <button id="change-pin-button" class="bg-current-input-bg hover:bg-current-bg-card-hover text-current-text-secondary font-bold py-2 px-4 rounded-xl focus:outline-none focus:shadow-outline flex items-center" aria-label="Ubah PIN">
                            <i class="fas fa-key mr-2"></i> Ubah PIN
                        </button>
                    </div>

                    <div class="thin-divider"></div>

                    <div>
                        <h4 class="text-xl font-semibold mb-2 text-current-text-primary">Tema & Tampilan</h4>
                        <div class="flex items-center space-x-4">
                            <span class="text-current-text-secondary">Mode Gelap/Terang:</span>
                            <label class="relative inline-flex items-center cursor-pointer" aria-label="Toggle Tema Gelap/Terang">
                                <input type="checkbox" value="" class="sr-only peer" id="theme-toggle">
                                <div class="w-11 h-6 bg-gray-700 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-current-accent-main rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-current-accent-main"></div>
                                <span class="ml-3 text-sm font-medium text-current-text-secondary" id="theme-status">Gelap</span>
                            </label>
                        </div>
                    </div>

                    <div class="thin-divider"></div>

                    <div>
                        <h4 class="text-xl font-semibold mb-2 text-current-text-primary">Reset Aplikasi</h4>
                        <button id="reset-app-button" class="bg-status-red hover:bg-red-700 text-current-text-primary font-bold py-2 px-4 rounded-xl focus:outline-none focus:shadow-outline flex items-center" aria-label="Reset Aplikasi">
                            <i class="fas fa-redo mr-2"></i> Reset Aplikasi
                        </button>
                        <p class="text-sm text-current-text-tertiary mt-2">Ini akan menghapus semua data Anda secara permanen dan mengatur ulang aplikasi.</p>
                    </div>

                </div>
            </section>
        </main>
    </div>

    <!-- Modals (Hidden by default) -->
    <!-- Generic Confirmation/Prompt Modal -->
    <div id="generic-modal" class="fixed inset-0 bg-current-bg-base bg-opacity-75 flex items-center justify-center z-50 hidden p-4">
        <div class="glass-card p-8 rounded-xl shadow-2xl max-w-md w-full animate-fadeInUp">
            <h3 id="modal-title" class="text-2xl font-bold mb-4 text-current-text-primary">Judul Modal</h3>
            <p id="modal-message" class="text-current-text-secondary mb-6">Pesan modal...</p>
            <input type="text" id="modal-input" class="shadow appearance-none border rounded-xl w-full py-2 px-3 bg-current-input-bg text-current-input-text leading-tight focus:outline-none mb-4 hidden" placeholder="Masukkan jumlah">
            <div class="flex justify-end space-x-4">
                <button id="modal-cancel-btn" class="bg-current-input-bg hover:bg-current-bg-card-hover text-current-text-secondary font-bold py-2 px-4 rounded-xl" aria-label="Batal">Batal</button>
                <button id="modal-confirm-btn" class="bg-current-accent-hover hover:bg-current-accent-dark text-current-text-primary font-bold py-2 px-4 rounded-xl" aria-label="Konfirmasi">Konfirmasi</button>
            </div>
        </div>
    </div>

    <!-- Profile Edit Modal -->
    <div id="profile-edit-modal" class="fixed inset-0 bg-current-bg-base bg-opacity-75 flex items-center justify-center z-50 hidden p-4">
        <div class="glass-card p-8 rounded-xl shadow-2xl max-w-md w-full animate-fadeInUp">
            <h3 class="text-2xl font-bold mb-4 text-current-text-primary">Edit Profil</h3>
            <div class="mb-4 flex items-center justify-center flex-col">
                <div class="w-24 h-24 rounded-full bg-current-accent-hover flex items-center justify-center text-current-text-primary text-4xl font-semibold overflow-hidden relative">
                    <img id="profile-modal-photo" src="" alt="Foto Profil" class="w-full h-full object-cover hidden">
                    <span id="profile-modal-initials" class="absolute">AB</span>
                    <label for="profile-photo-upload" class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-50 text-white cursor-pointer opacity-0 hover:opacity-100 transition-opacity duration-200" title="Unggah Foto">
                        <i class="fas fa-camera"></i>
                        <input type="file" id="profile-photo-upload" accept="image/*" class="hidden">
                    </label>
                </div>
                <button id="remove-profile-photo-btn" class="mt-2 status-red hover:text-status-red text-sm hidden" aria-label="Hapus Foto Profil">Hapus Foto</button>
            </div>
            <div class="mb-4">
                <label for="profile-name-input" class="block text-current-text-secondary text-sm font-bold mb-2">Nama Pengguna</label>
                <input type="text" id="profile-name-input" class="shadow appearance-none border rounded-xl w-full py-2 px-3 bg-current-input-bg text-current-input-text leading-tight focus:outline-none" placeholder="Masukkan nama Anda">
            </div>
            <div class="flex justify-end space-x-4">
                <button id="profile-modal-cancel-btn" class="bg-current-input-bg hover:bg-current-bg-card-hover text-current-text-secondary font-bold py-2 px-4 rounded-xl" aria-label="Batal Edit Profil">Batal</button>
                <button id="profile-modal-save-btn" class="bg-current-accent-hover hover:bg-current-accent-dark text-current-text-primary font-bold py-2 px-4 rounded-xl" aria-label="Simpan Profil">Simpan</button>
            </div>
        </div>
    </div>

    <!-- Currency Management Modal -->
    <div id="currency-modal" class="fixed inset-0 bg-current-bg-base bg-opacity-75 flex items-center justify-center z-50 hidden p-4">
        <div class="glass-card p-8 rounded-xl shadow-2xl max-w-md w-full animate-fadeInUp">
            <h3 class="text-2xl font-bold mb-4 text-current-text-primary">Kelola Mata Uang Tabungan</h3>
            
            <div class="mb-4">
                <h4 class="text-xl font-semibold mb-2 text-current-text-primary">Mata Uang Aktif</h4>
                <div id="active-currencies-list" class="space-y-2">
                    <!-- Active currencies will be listed here -->
                    <p class="text-current-text-secondary">IDR - Rupiah Indonesia <span class="text-current-accent-main">(Default)</span></p>
                </div>
            </div>

            <div class="thin-divider my-4"></div>

            <h4 class="text-xl font-semibold mb-2 text-current-text-primary">Tambahkan Mata Uang Baru</h4>
            <form id="add-currency-form" class="grid grid-cols-1 gap-4">
                <div>
                    <label for="new-currency-code" class="block text-current-text-secondary text-sm font-bold mb-2">Kode Mata Uang (mis. USD, EUR)</label>
                    <input type="text" id="new-currency-code" class="shadow appearance-none border rounded-xl w-full py-2 px-3 bg-current-input-bg text-current-input-text leading-tight uppercase" maxlength="3" placeholder="Contoh: USD" required>
                </div>
                <div>
                    <label for="new-currency-name" class="block text-current-text-secondary text-sm font-bold mb-2">Nama Mata Uang</label>
                    <input type="text" id="new-currency-name" class="shadow appearance-none border rounded-xl w-full py-2 px-3 bg-current-input-bg text-current-input-text leading-tight" placeholder="Contoh: Dolar Amerika" required>
                </div>
                <div>
                    <label for="new-currency-symbol" class="block text-current-text-secondary text-sm font-bold mb-2">Simbol Mata Uang (mis. $, €)</label>
                    <input type="text" id="new-currency-symbol" class="shadow appearance-none border rounded-xl w-full py-2 px-3 bg-current-input-bg text-current-input-text leading-tight" maxlength="5" placeholder="Contoh: $" required>
                </div>
                <div class="flex justify-end">
                    <button type="submit" class="bg-current-accent-hover hover:bg-current-accent-dark text-current-text-primary font-bold py-2 px-6 rounded-xl focus:outline-none focus:shadow-outline flex items-center" aria-label="Tambahkan Mata Uang">
                        <i class="fas fa-plus-circle mr-2"></i> Tambah Mata Uang
                    </button>
                </div>
            </form>

            <div class="flex justify-end space-x-4 mt-6">
                <button id="currency-modal-close-btn" class="bg-current-input-bg hover:bg-current-bg-card-hover text-current-text-secondary font-bold py-2 px-4 rounded-xl" aria-label="Tutup">Tutup</button>
            </div>
        </div>
    </div>


    <script type="module">
        // Function to generate unique IDs
        const generateId = () => crypto.randomUUID();

        // Web Crypto API for hashing (SHA-256)
        async function hashPin(pin, salt) {
            const encoder = new TextEncoder();
            const data = encoder.encode(pin + salt);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            return hashHex;
        }

        function generateSalt(length = 16) {
            const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let result = '';
            const charactersLength = characters.length;
            for (let i = 0; i < length; i++) {
                result += characters.charAt(Math.floor(Math.random() * charactersLength));
            }
            return result;
        }

        // Main application data model, stored in LocalStorage
        let appData = {
            userProfile: {
                name: 'Pengguna FinanSync',
                initials: 'PF',
                theme: 'dark',
                profilePhotoUrl: null,
                pinHash: null, // Stores the hashed PIN
                pinSalt: null  // Stores the salt for the PIN
            },
            investments: [],
            savingsGoals: [],
            transactions: [],
            cashSavings: {
                IDR: 0, // Only IDR by default
            },
            goldSavings: 0,
            emergencyFund: {
                target: 0, current: 0
            },
            budgets: [],
            billReminders: [],
            debts: [],
            customCurrencies: [] // New array to store custom currencies [{code: 'USD', name: 'Dolar Amerika', symbol: '$'}]
        };

        // Static exchange rates for currency conversion (for demonstration)
        // These will be used for tools and internal conversions to IDR for totals.
        // Users can define custom currencies for savings, but their exchange rates
        // will not be managed or updated dynamically in this demo.
        const EXCHANGE_RATES = {
            'IDR_USD': 0.000062, 'USD_IDR': 16100,
            'IDR_EUR': 0.000058, 'EUR_IDR': 17200,
            'USD_EUR': 0.93, 'EUR_USD': 1.07
            // Custom currencies will not have automatic exchange rates
        };

        // Get DOM elements for various parts of the application
        const loadingOverlay = document.getElementById('loading-overlay');
        const sidebar = document.getElementById('sidebar');
        const sidebarToggleOpen = document.getElementById('sidebar-toggle-open');
        const sidebarToggleClose = document.getElementById('sidebar-toggle-close');
        const navLinks = document.querySelectorAll('.nav-link');
        const sections = document.querySelectorAll('.section-content');
        const pageTitle = document.getElementById('page-title');
        const mainAppContainer = document.getElementById('app'); // Main container for the app content
        const mainContent = document.getElementById('main-content'); // Get main content element

        // Header Profile Elements
        const profileAvatar = document.getElementById('profile-avatar');
        const profilePhoto = document.getElementById('profile-photo');
        const profileInitials = document.getElementById('profile-initials');

        // Dashboard Elements
        const totalInvestmentsEl = document.getElementById('total-investments');
        const totalSavingsEl = document.getElementById('total-savings');
        const netWorthEl = document.getElementById('net-worth');
        const financialHealthScoreCard = document.getElementById('financial-health-score-card');
        const financialScoreEl = document.getElementById('financial-score');
        const financialAssessmentEl = document.getElementById('financial-assessment');
        const assetAllocationChartCanvas = document.getElementById('assetAllocationChart');
        const cashflowChartCanvas = document.getElementById('cashflowChart');
        const assetAllocationSkeleton = document.getElementById('asset-allocation-skeleton');
        const cashflowSkeleton = document.getElementById('cashflow-skeleton');
        let assetAllocationChart;
        let cashflowChart;

        // Investment Elements
        const addInvestmentForm = document.getElementById('add-investment-form');
        const assetTypeSelect = document.getElementById('asset-type');
        const assetPricePerUnitGroup = document.getElementById('asset-price-per-unit-group');
        const assetPricePerUnitInput = document.getElementById('asset-price-per-unit');
        const investmentsList = document.getElementById('investments-list');

        // Savings Elements
        const addSavingGoalForm = document.getElementById('add-saving-goal-form');
        const savingGoalsList = document.getElementById('saving-goals-list');
        const currencySavingsContainer = document.getElementById('currency-savings-container'); // Container for dynamic currency savings
        const currentIdrSavingsEl = document.getElementById('current-idr-savings');
        const currentGoldSavingsEl = document.getElementById('current-gold-savings');
        // const addFundsButtons = document.querySelectorAll('.add-funds-btn'); // Will be dynamic
        const emergencyFundTargetEl = document.getElementById('emergency-fund-target');
        const emergencyFundCurrentEl = document.getElementById('emergency-fund-current');
        const emergencyFundProgressBar = document.getElementById('emergency-fund-progress-bar');
        const emergencyFundPercentageEl = document.getElementById('emergency-fund-percentage');
        const setEmergencyFundBtn = document.getElementById('set-emergency-fund-btn');


        // Transaction Elements
        const addTransactionForm = document.getElementById('add-transaction-form');
        const transactionsList = document.getElementById('transactions-list');
        const filterTime = document.getElementById('filter-time');
        const filterType = document.getElementById('filter-type');

        // Budget Elements
        const setBudgetForm = document.getElementById('set-budget-form');
        const budgetList = document.getElementById('budget-list');
        const currentMonthBudgetSummary = document.getElementById('current-month-budget-summary');

        // Bill Reminder Elements
        const addBillForm = document.getElementById('add-bill-form');
        const billsList = document.getElementById('bills-list');
        const filterBills = document.getElementById('filter-bills');

        // Debt Elements
        const addDebtForm = document.getElementById('add-debt-form');
        const debtsList = document.getElementById('debts-list');

        // Tools Elements
        const principalInput = document.getElementById('principal');
        const annualRateInput = document.getElementById('annual-rate');
        const yearsInput = document.getElementById('years');
        const compoundFrequencySelect = document.getElementById('compound-frequency');
        const calculateCompoundBtn = document.getElementById('calculate-compound-btn');
        const compoundResultEl = document.getElementById('compound-result');

        const currentAgeInput = document.getElementById('current-age');
        const retirementAgeInput = document.getElementById('retirement-age');
        const currentRetirementSavingsInput = document.getElementById('current-retirement-savings');
        const annualContributionInput = document.getElementById('annual-contribution');
        const estimatedReturnInput = document.getElementById('estimated-return');
        const calculateRetirementBtn = document.getElementById('calculate-retirement-btn');
        const retirementResultEl = document.getElementById('retirement-result');

        const fromCurrencyAmountInput = document.getElementById('from-currency-amount');
        const fromCurrencySelect = document.getElementById('from-currency');
        const toCurrencySelect = document.getElementById('to-currency');
        const convertCurrencyBtn = document.getElementById('convert-currency-btn');
        const conversionResultEl = document.getElementById('conversion-result');

        const riskQ1Select = document.getElementById('risk-q1');
        const riskQ2Select = document.getElementById('risk-q2');
        const calculateRiskBtn = document.getElementById('calculate-risk-btn');
        const riskResultEl = document.getElementById('risk-result');


        // Settings Elements
        const settingsButton = document.getElementById('settings-button'); // Get the settings button from header
        const exportDataBtn = document.getElementById('export-data-btn');
        const importFile = document.getElementById('import-file');
        const backupDataBtn = document.getElementById('backup-data-btn');
        const themeToggle = document.getElementById('theme-toggle');
        const themeStatus = document.getElementById('theme-status');
        const changePinButton = document.getElementById('change-pin-button'); // Change PIN button
        const resetAppButton = document.getElementById('reset-app-button'); // New reset app button
        const manageCurrenciesBtn = document.getElementById('manage-currencies-btn'); // New button for currency management

        // Modals
        const genericModal = document.getElementById('generic-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalInput = document.getElementById('modal-input');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');

        const profileEditModal = document.getElementById('profile-edit-modal');
        const profileNameInput = document.getElementById('profile-name-input');
        const profileModalPhoto = document.getElementById('profile-modal-photo');
        const profileModalInitials = document.getElementById('profile-modal-initials');
        const profilePhotoUpload = document.getElementById('profile-photo-upload');
        const removeProfilePhotoBtn = document.getElementById('remove-profile-photo-btn');
        const profileModalCancelBtn = document.getElementById('profile-modal-cancel-btn');
        const profileModalSaveBtn = document.getElementById('profile-modal-save-btn');

        // Currency Management Modal elements
        const currencyModal = document.getElementById('currency-modal');
        const activeCurrenciesList = document.getElementById('active-currencies-list');
        const addCurrencyForm = document.getElementById('add-currency-form');
        const newCurrencyCodeInput = document.getElementById('new-currency-code');
        const newCurrencyNameInput = document.getElementById('new-currency-name');
        const newCurrencySymbolInput = document.getElementById('new-currency-symbol');
        const currencyModalCloseBtn = document.getElementById('currency-modal-close-btn');

        // PIN Screen Elements
        const pinScreen = document.getElementById('pin-screen');
        const pinScreenTitle = document.getElementById('pin-screen-title');
        const pinInputDisplay = document.getElementById('pin-input-display'); // This will hold digit displays
        const pinMessage = document.getElementById('pin-message');
        const pinKeypad = document.getElementById('pin-keypad'); // The keypad container
        const pinShowHideButton = document.getElementById('pin-show-hide-button');
        const pinActionButton = document.getElementById('pin-action-button');
        const forgotPinButton = document.getElementById('forgot-pin-button');

        let currentEnteredPin = ''; // Stores the currently entered PIN (raw digits)
        let pinVisibilityHidden = true; // True for hidden (dots), false for visible (digits)

        let currentPinAction = ''; // 'setup', 'confirm_setup', 'entry', 'change_old', 'change_new', 'change_confirm', 'reset_confirm', 'import_verify'
        let tempPin = ''; // Used for PIN setup/change confirmation
        let failedPinAttempts = 0;
        const MAX_FAILED_ATTEMPTS = 3;
        const LOCKOUT_DURATION = 30000; // 30 seconds

        let inactivityTimer;
        const INACTIVITY_TIMEOUT = 10 * 60 * 1000; // 10 minutes in milliseconds

        // --- Core Functions ---

        /**
         * Resets and starts the inactivity timer.
         */
        const resetInactivityTimer = () => {
            clearTimeout(inactivityTimer);
            if (mainAppContainer.classList.contains('hidden')) { // Only start timer if main app is visible
                return;
            }
            inactivityTimer = setTimeout(() => {
                showModal('Sesi Kadaluarsa', 'Anda telah tidak aktif. Silakan masukkan PIN Anda untuk melanjutkan.', false).then(() => {
                    currentEnteredPin = ''; // Clear PIN on re-entry
                    showPinScreen('entry');
                });
            }, INACTIVITY_TIMEOUT);
        };

        // Event listeners for user activity
        ['mousemove', 'mousedown', 'keypress', 'scroll', 'touchstart'].forEach(eventType => {
            document.addEventListener(eventType, resetInactivityTimer, true);
        });


        /**
         * Formats a number with thousands separators (dots for Indonesian locale).
         * @param {number} num - The number to format.
         * @param {number} maxDecimals - Maximum number of decimal places.
         * @returns {string} The formatted string.
         */
        const formatNumberWithDots = (num, maxDecimals = 2) => {
            if (num === null || isNaN(num) || num === '') return '';
            // Handle scientific notation for very small numbers, just display as is
            if (Math.abs(num) < 0.000001 && num !== 0) {
                 return num.toString();
            }

            return new Intl.NumberFormat('id-ID', {
                minimumFractionDigits: 0, // Allow 0 decimal places if integer
                maximumFractionDigits: maxDecimals
            }).format(num);
        };

        /**
         * Parses a formatted string back into a pure number.
         * Handles both dot and comma as decimal separators depending on locale conventions,
         * but for this app, assumes dot for thousands and comma for decimals for robust parsing.
         * @param {string} str - The string to parse.
         * @returns {number} The parsed number.
         */
        const parseNumberFromFormattedString = (str) => {
            if (!str) return 0;
            // Remove dots (thousands separator), then replace comma (decimal separator, if any) with dot
            const cleanedStr = str.toString().replace(/\./g, '').replace(/,/g, '.');
            return parseFloat(cleanedStr);
        };

        /**
         * Applies currency input formatting behavior to a given input element.
         * @param {HTMLElement} inputElement - The input element to apply formatting to.
         * @param {number} defaultMaxDecimals - Default maximum number of decimal places for display.
         */
        const applyCurrencyInputFormatting = (inputElement, defaultMaxDecimals = 2) => {
            // Remove previous listeners to prevent duplicates
            const oldInputHandler = inputElement._inputHandler;
            const oldBlurHandler = inputElement._blurHandler;
            const oldFocusHandler = inputElement._focusHandler;

            if (oldInputHandler) inputElement.removeEventListener('input', oldInputHandler);
            if (oldBlurHandler) inputElement.removeEventListener('blur', oldBlurHandler);
            if (oldFocusHandler) inputElement.removeEventListener('focus', oldFocusHandler);

            const inputHandler = (e) => {
                const caretPos = e.target.selectionStart;
                const originalValue = e.target.value;
                const pureNumber = parseNumberFromFormattedString(originalValue);

                if (!isNaN(pureNumber) && originalValue.length > 0) {
                    // Temporarily remove dots for caret position calculation if they are inserted
                    const valWithoutDots = originalValue.replace(/\./g, '');
                    const newFormattedValue = formatNumberWithDots(pureNumber, defaultMaxDecimals);
                    e.target.value = newFormattedValue;

                    // Adjust caret position based on new dot insertions
                    let dotsAdded = newFormattedValue.length - valWithoutDots.length;
                    let newCaretPos = caretPos + dotsAdded;

                    // Handle backspace or deletion: if dots were removed, adjust caret left
                    if (originalValue.length > newFormattedValue.length) {
                         const diff = originalValue.length - newFormattedValue.length;
                         newCaretPos = caretPos - diff;
                    }
                    e.target.setSelectionRange(newCaretPos, newCaretPos);

                } else if (originalValue === '') {
                    e.target.value = '';
                }
            };

            const blurHandler = (e) => {
                const pureNumber = parseNumberFromFormattedString(e.target.value);
                if (!isNaN(pureNumber)) {
                    e.target.value = formatNumberWithDots(pureNumber, defaultMaxDecimals);
                } else {
                    e.target.value = ''; // Clear if not a valid number on blur
                }
            };

            const focusHandler = (e) => {
                const pureNumber = parseNumberFromFormattedString(e.target.value);
                e.target.value = pureNumber === 0 ? '' : pureNumber.toString();
            };

            inputElement.addEventListener('input', inputHandler);
            inputElement.addEventListener('blur', blurHandler);
            inputElement.addEventListener('focus', focusHandler);

            // Store handlers to remove later
            inputElement._inputHandler = inputHandler;
            inputElement._blurHandler = blurHandler;
            inputElement._focusHandler = focusHandler;


            // Initial formatting on load
            const initialValue = parseNumberFromFormattedString(inputElement.value);
            if (!isNaN(initialValue) && initialValue !== 0) {
                inputElement.value = formatNumberWithDots(initialValue, defaultMaxDecimals);
            } else {
                inputElement.value = '';
            }
        };

        /**
         * Recalculates crypto amount based on acquisition value and price per unit.
         */
        const calculateCryptoAmount = () => {
            const assetType = assetTypeSelect.value;
            const assetValueInput = document.getElementById('asset-value'); // Ensure to get fresh values
            const assetAmountInput = document.getElementById('asset-amount'); // Ensure to get fresh values

            const value = parseNumberFromFormattedString(assetValueInput.value);
            const pricePerUnit = parseNumberFromFormattedString(assetPricePerUnitInput.value);

            if (assetType === 'Kripto' && value > 0 && pricePerUnit > 0) {
                const calculatedAmount = value / pricePerUnit;
                // Directly set the raw number, the formatter on blur/input will handle display
                assetAmountInput.value = calculatedAmount.toFixed(8); // High precision for crypto units
            } else if (assetType === 'Kripto') {
                // If inputs are not valid for calculation, clear the amount
                assetAmountInput.value = '';
            }
        };

        /**
         * Shows the generic modal with a message and optional input.
         * @param {string} title - The title of the modal.
         * @param {string} message - The message to display.
         * @param {boolean} showInput - Whether to show the input field.
         * @param {string} inputPlaceholder - Placeholder for the input field.
         * @param {string} inputType - Type of the input field (e.g., 'number', 'text', 'password').
         * @returns {Promise<{confirmed: boolean, value: string|number|null}>} - A promise that resolves when the modal is closed.
         */
        const showModal = (title, message, showInput = false, inputPlaceholder = '', inputType = 'text') => { // Default to text input for general modal for flexibility
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            if (showInput) {
                modalInput.type = inputType;
                modalInput.placeholder = inputPlaceholder;
                modalInput.value = ''; // Clear value on show
                modalInput.classList.remove('hidden');
                if (inputType === 'number') {
                    // Apply currency input formatting to modal input if it's a number
                    applyCurrencyInputFormatting(modalInput, 2); // Default 2 decimals for modal numeric input
                } else {
                    // Remove previously applied formatting handlers if switching type
                    if (modalInput._inputHandler) modalInput.removeEventListener('input', modalInput._inputHandler);
                    if (modalInput._blurHandler) modalInput.removeEventListener('blur', modalInput._blurHandler);
                    if (modalInput._focusHandler) modalInput.removeEventListener('focus', modalInput._focusHandler);
                }
            } else {
                modalInput.classList.add('hidden');
            }
            genericModal.classList.remove('hidden');

            return new Promise(resolve => {
                const confirmHandler = () => {
                    let value = showInput ? modalInput.value : null;
                    if (showInput && inputType === 'number') {
                        value = parseNumberFromFormattedString(value); // Parse formatted number back to pure number
                    }
                    genericModal.classList.add('hidden');
                    modalConfirmBtn.removeEventListener('click', confirmHandler);
                    modalCancelBtn.removeEventListener('click', cancelHandler);
                    resolve({ confirmed: true, value: value });
                };

                const cancelHandler = () => {
                    genericModal.classList.add('hidden');
                    modalConfirmBtn.removeEventListener('click', confirmHandler);
                    modalCancelBtn.removeEventListener('click', cancelHandler);
                    resolve({ confirmed: false, value: null });
                };

                modalConfirmBtn.addEventListener('click', confirmHandler);
                modalCancelBtn.addEventListener('click', cancelHandler);
            });
        };

        /**
         * Saves appData to LocalStorage.
         */
        const saveAppData = () => {
            try {
                // To avoid storing plaintext PIN, create a copy of appData before stringifying
                const dataToStore = JSON.parse(JSON.stringify(appData));
                if (dataToStore.userProfile && dataToStore.userProfile.pin) {
                    delete dataToStore.userProfile.pin; // Ensure plaintext PIN is not saved to LocalStorage
                }
                localStorage.setItem('finansyncData', JSON.stringify(dataToStore));
                console.log('Data disimpan ke LocalStorage.');
            } catch (error) {
                console.error('Gagal menyimpan data ke LocalStorage:', error);
                showModal('Kesalahan Penyimpanan', 'Gagal menyimpan data ke penyimpanan lokal. Pastikan browser Anda mengizinkan penyimpanan data situs.');
            }
        };

        /**
         * Loads appData from LocalStorage.
         */
        const loadAppData = () => {
            try {
                const storedData = localStorage.getItem('finansyncData');
                if (storedData) {
                    const parsedData = JSON.parse(storedData);
                    appData = {
                        userProfile: {
                            name: parsedData.userProfile?.name || 'Pengguna FinanSync',
                            initials: parsedData.userProfile?.initials || 'PF',
                            theme: parsedData.userProfile?.theme || 'dark',
                            profilePhotoUrl: parsedData.userProfile?.profilePhotoUrl || null,
                            pinHash: parsedData.userProfile?.pinHash || null, // Load PIN hash
                            pinSalt: parsedData.userProfile?.pinSalt || null  // Load PIN salt
                        },
                        investments: parsedData.investments || [],
                        savingsGoals: parsedData.savingsGoals || [],
                        transactions: parsedData.transactions || [],
                        // Ensure cashSavings handles new currencies
                        cashSavings: parsedData.cashSavings || {}, // Will be populated with IDR by default if empty
                        goldSavings: parsedData.goldSavings || 0,
                        emergencyFund: {
                            target: parsedData.emergencyFund?.target || 0,
                            current: parsedData.emergencyFund?.current || 0
                        },
                        budgets: parsedData.budgets || [],
                        billReminders: parsedData.billReminders || [],
                        debts: parsedData.debts || [],
                        customCurrencies: parsedData.customCurrencies || [] // Load custom currencies
                    };

                    // Initialize cashSavings for IDR if not present
                    if (typeof appData.cashSavings.IDR === 'undefined') {
                        appData.cashSavings.IDR = 0;
                    }
                    // Initialize other custom currencies in cashSavings if not present
                    appData.customCurrencies.forEach(currency => {
                        if (typeof appData.cashSavings[currency.code] === 'undefined') {
                            appData.cashSavings[currency.code] = 0;
                        }
                    });

                    console.log('Data dimuat dari LocalStorage.');
                }
            } catch (error) {
                console.error('Gagal memuat data dari LocalStorage:', error);
            }
        };

        /**
         * Formats a number as IDR currency.
         * @param {number} amount - The amount to format.
         * @returns {string} - Formatted currency string.
         */
        const formatCurrencyIDR = (amount) => {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0,
                maximumFractionDigits: 2
            }).format(amount);
        };

        /**
         * Formats a number to the correct currency symbol based on appData.customCurrencies.
         * @param {number} amount - The amount.
         * @param {string} currencyCode - 'IDR', 'USD', 'EUR', or custom codes.
         * @returns {string} - Formatted string with symbol.
         */
        const formatAmountWithSymbol = (amount, currencyCode) => {
            // First, try to find in custom currencies
            const customCurrency = appData.customCurrencies.find(c => c.code === currencyCode);
            if (customCurrency) {
                return `${customCurrency.symbol} ${formatNumberWithDots(amount)}`;
            }

            // Fallback for default hardcoded currencies and a general number format
            switch (currencyCode) {
                case 'IDR': return formatCurrencyIDR(amount);
                case 'USD': return `$ ${formatNumberWithDots(amount)}`;
                case 'EUR': return `€ ${formatNumberWithDots(amount)}`;
                default: return `${currencyCode} ${formatNumberWithDots(amount)}`; // Generic fallback
            }
        };

        /**
         * Converts amount from one currency to another using static rates.
         * Only supports IDR, USD, EUR for conversion. Custom currencies cannot be converted.
         * @param {number} amount - The amount to convert.
         * @param {string} fromCur - The currency to convert from (e.g., 'IDR', 'USD').
         * @param {string} toCur - The currency to convert to.
         * @returns {number} - Converted amount.
         */
        const convertCurrency = (amount, fromCur, toCur) => {
            if (fromCur === toCur) {
                return amount;
            }

            // Check if either currency is a custom one not in the static rates
            const isFromCustom = appData.customCurrencies.some(c => c.code === fromCur) && !(fromCur === 'USD' || fromCur === 'EUR');
            const isToCustom = appData.customCurrencies.some(c => c.code === toCur) && !(toCur === 'USD' || toCur === 'EUR');

            if (isFromCustom || isToCustom) {
                // If either is a custom currency that is not USD/EUR (which have hardcoded rates),
                // we cannot convert it with the static rates.
                console.warn(`Konversi mata uang untuk ${fromCur} atau ${toCur} tidak didukung dengan nilai tukar statis.`);
                return amount; // Return original amount if conversion is not supported
            }

            const rateKey = `${fromCur}_${toCur}`;
            if (EXCHANGE_RATES[rateKey]) {
                return amount * EXCHANGE_RATES[rateKey];
            }
            // If direct rate not found, try inverse or via a base currency (e.g., USD)
            if (fromCur !== 'USD' && toCur !== 'USD') {
                // Convert fromCur to USD, then from USD to toCur
                const amountInUSD = convertCurrency(amount, fromCur, 'USD');
                return convertCurrency(amountInUSD, 'USD', toCur);
            }
            console.warn(`Tidak ditemukan nilai tukar langsung untuk ${fromCur} ke ${toCur}.`);
            return amount; // Return original amount if no rate found
        };

        /**
         * Formats a number as grams for gold.
         * @param {number} amount - The amount in grams.
         * @returns {string} - Formatted string.
         */
        const formatGoldGram = (amount) => {
            return `${formatNumberWithDots(amount)} gram`;
        };

        /**
         * Updates the profile initials or photo in the header and modal.
         */
        const updateProfileDisplay = () => {
            if (appData.userProfile.profilePhotoUrl) {
                profilePhoto.src = appData.userProfile.profilePhotoUrl;
                profilePhoto.classList.remove('hidden');
                profileInitials.classList.add('hidden'); // Hide initials
                profileModalPhoto.src = appData.userProfile.profilePhotoUrl;
                profileModalPhoto.classList.remove('hidden');
                profileModalInitials.classList.add('hidden'); // Hide modal initials
                removeProfilePhotoBtn.classList.remove('hidden'); // Show remove button
            } else {
                profilePhoto.classList.add('hidden');
                profileInitials.classList.remove('hidden'); // Show initials
                profileModalPhoto.classList.add('hidden');
                profileModalInitials.classList.remove('hidden'); // Show modal initials
                removeProfilePhotoBtn.classList.add('hidden'); // Hide remove button

                if (appData.userProfile.name) {
                    const nameParts = appData.userProfile.name.split(' ').filter(n => n);
                    if (nameParts.length > 1) {
                        profileInitials.textContent = (nameParts[0][0] + nameParts[nameParts.length - 1][0]).toUpperCase();
                        profileModalInitials.textContent = (nameParts[0][0] + nameParts[nameParts.length - 1][0]).toUpperCase();
                    } else if (nameParts.length === 1) {
                        profileInitials.textContent = nameParts[0][0].toUpperCase();
                        profileModalInitials.textContent = nameParts[0][0].toUpperCase();
                    } else {
                        profileInitials.textContent = 'AU'; // Default if name is empty
                        profileModalInitials.textContent = 'AU';
                    }
                } else {
                    profileInitials.textContent = 'AU'; // Default
                    profileModalInitials.textContent = 'AU';
                }
            }
        };

        /**
         * Applies the selected theme to the body and updates UI elements.
         * @param {string} theme - 'dark' or 'light'.
         */
        const applyTheme = (theme) => {
            document.body.classList.remove('dark-mode', 'light-mode');
            if (theme === 'light') {
                document.body.classList.add('light-mode');
                themeStatus.textContent = 'Terang';
                themeToggle.checked = true;
            } else {
                document.body.classList.add('dark-mode'); // Explicitly add dark-mode for clarity
                themeStatus.textContent = 'Gelap';
                themeToggle.checked = false;
            }
            updateChartThemeColors(theme);
            // Re-render other elements that might have dynamic colors
            renderDashboardSummary();
            renderInvestments();
            renderSavings(); // Re-render savings section to apply theme to dynamically added currency cards
            renderTransactions();
            renderBudgets();
            renderBillReminders();
            renderDebts();
        };

        /**
         * Updates chart colors based on the current theme.
         * @param {string} theme - 'dark' or 'light'.
         */
        const updateChartThemeColors = (theme) => {
            const textColor = theme === 'light' ? '#1a1a1a' : '#e5e5e5';
            const gridColor = theme === 'light' ? 'rgba(0,0,0,0.08)' : 'rgba(255,255,255,0.08)';
            // Make sure these colors are consistent with your CSS variables
            const incomeColor = theme === 'light' ? 'rgba(22, 163, 74, 0.8)' : 'rgba(0, 255, 136, 0.8)';
            const expenseColor = theme === 'light' ? 'rgba(220, 38, 38, 0.8)' : 'rgba(239, 68, 68, 0.8)';
            const investmentColors = [
                theme === 'light' ? 'rgba(22, 163, 74, 0.8)' : 'rgba(0, 255, 136, 0.8)', // Primary accent
                theme === 'light' ? 'rgba(21, 128, 61, 0.8)' : 'rgba(34, 197, 94, 0.8)', // Secondary accent
                'rgba(59, 130, 246, 0.8)',   // Blue
                'rgba(234, 179, 8, 0.8)',    // Yellow
                'rgba(239, 68, 68, 0.8)',    // Red
                'rgba(168, 85, 247, 0.8)',   // Purple
                'rgba(249, 115, 22, 0.8)'    // Orange
            ];

            // Update Asset Allocation Chart (Pie)
            if (assetAllocationChart) {
                assetAllocationChart.options.plugins.legend.labels.color = textColor;
                assetAllocationChart.options.plugins.tooltip.titleColor = textColor;
                assetAllocationChart.options.plugins.tooltip.bodyColor = textColor;
                assetAllocationChart.data.datasets[0].backgroundColor = investmentColors;
                assetAllocationChart.data.datasets[0].borderColor = investmentColors.map(color => color.replace('0.8)', '1)'));
                assetAllocationChart.update();
            }

            // Update Cashflow Chart (Bar)
            if (cashflowChart) {
                cashflowChart.options.plugins.legend.labels.color = textColor;
                cashflowChart.options.scales.x.ticks.color = textColor;
                cashflowChart.options.scales.x.grid.color = gridColor;
                cashflowChart.options.scales.y.ticks.color = textColor;
                cashflowChart.options.scales.y.grid.color = gridColor;
                cashflowChart.options.plugins.tooltip.titleColor = textColor;
                cashflowChart.options.plugins.tooltip.bodyColor = textColor;
                cashflowChart.data.datasets[0].backgroundColor = incomeColor;
                cashflowChart.data.datasets[0].borderColor = incomeColor.replace('0.8)', '1)');
                cashflowChart.data.datasets[1].backgroundColor = expenseColor;
                cashflowChart.data.datasets[1].borderColor = expenseColor.replace('0.8)', '1)');
                cashflowChart.update();
            }
        };

        /**
         * Renders the dashboard summary.
         */
        const renderDashboardSummary = () => {
            const totalInvestmentsValue = appData.investments.reduce((sum, inv) => sum + (inv.currentValue || inv.value), 0);

            // Convert all cash savings to IDR for total calculation.
            // Only convert currencies that have exchange rates defined.
            let totalCashSavingsIDR = appData.cashSavings.IDR || 0;
            appData.customCurrencies.forEach(currency => {
                if (currency.code !== 'IDR' && EXCHANGE_RATES[`${currency.code}_IDR`]) {
                    totalCashSavingsIDR += convertCurrency(appData.cashSavings[currency.code] || 0, currency.code, 'IDR');
                }
            });

            const totalDebtsValue = appData.debts.reduce((sum, debt) => sum + debt.currentBalance, 0);

            const netWorth = (totalInvestmentsValue + totalCashSavingsIDR) - totalDebtsValue;

            totalInvestmentsEl.textContent = formatCurrencyIDR(totalInvestmentsValue);
            totalSavingsEl.textContent = formatCurrencyIDR(totalCashSavingsIDR);
            netWorthEl.textContent = formatCurrencyIDR(netWorth);

            renderFinancialHealthScore(totalInvestmentsValue + totalCashSavingsIDR, totalDebtsValue);
        };

        /**
         * Calculates and renders the financial health score.
         * @param {number} totalAssets - Total value of investments and savings.
         * @param {number} totalDebts - Total value of all debts.
         */
        const renderFinancialHealthScore = (totalAssets, totalDebts) => {
            let score = 0;
            let assessment = '';
            let scoreBorderClass = 'score-border-default';
            let scoreTextColorClass = 'text-current-accent-main';

            // Debt-to-Asset Ratio (lower is better)
            const debtToAssetRatio = totalAssets > 0 ? (totalDebts / totalAssets) : (totalDebts > 0 ? 1 : 0); // Handle division by zero

            if (debtToAssetRatio <= 0.1) { // 10% or less debt
                score += 50;
            } else if (debtToAssetRatio <= 0.3) { // 10-30% debt
                score += 30;
            } else if (debtToAssetRatio <= 0.5) { // 30-50% debt
                score += 10;
            } else {
                score += 0;
            }

            // Savings Proportion (higher is better)
            const averageMonthlyExpenses = appData.transactions.filter(t => t.type === 'expense')
                .reduce((acc, t) => {
                    const monthYear = new Date(t.date).toISOString().slice(0, 7);
                    acc[monthYear] = (acc[monthYear] || 0) + t.amount;
                    return acc;
                }, {});

            const numMonthsWithExpenses = Object.keys(averageMonthlyExpenses).length;
            const totalRecordedExpenses = Object.values(averageMonthlyExpenses).reduce((sum, val) => sum + val, 0);
            const avgMonthlyExpense = numMonthsWithExpenses > 0 ? totalRecordedExpenses / numMonthsWithExpenses : 0;

            if (appData.cashSavings.IDR > avgMonthlyExpense * 6) { // More than 6 months of expenses saved
                score += 50;
            } else if (appData.cashSavings.IDR > avgMonthlyExpense * 3) { // 3-6 months saved
                score += 30;
            } else if (appData.cashSavings.IDR > avgMonthlyExpense * 1) { // 1-3 months saved
                score += 10;
            } else {
                score += 0;
            }

            // Cap score at 100
            score = Math.min(100, score);

            if (totalAssets === 0 && totalDebts === 0) {
                assessment = 'Tidak ada data untuk dinilai.';
                financialScoreEl.textContent = '--';
                financialAssessmentEl.textContent = assessment;
                financialScoreEl.className = 'text-6xl font-bold text-current-accent-main transition-colors duration-300';
                financialHealthScoreCard.className = 'glass-card p-6 rounded-xl shadow-lg score-border-default transition-all duration-300';
                return;
            }

            if (score >= 80) {
                assessment = 'Sangat Baik! Keuangan Anda solid.';
                scoreBorderClass = 'score-border-green';
                scoreTextColorClass = 'status-green';
            } else if (score >= 50) {
                assessment = 'Baik. Ada ruang untuk perbaikan.';
                scoreBorderClass = 'score-border-yellow';
                scoreTextColorClass = 'status-yellow';
            } else {
                assessment = 'Perlu Perbaikan. Perhatikan utang & tabungan.';
                scoreBorderClass = 'score-border-red';
                scoreTextColorClass = 'status-red';
            }

            financialScoreEl.textContent = `${score}`;
            financialAssessmentEl.textContent = assessment;
            financialScoreEl.className = `text-6xl font-bold ${scoreTextColorClass} transition-colors duration-300`;
            financialHealthScoreCard.className = `glass-card p-6 rounded-xl shadow-lg ${scoreBorderClass} transition-all duration-300`;
        };


        /**
         * Renders the asset allocation chart.
         */
        const renderAssetAllocationChart = () => {
            assetAllocationSkeleton.classList.remove('hidden'); // Show skeleton
            if (assetAllocationChart) {
                assetAllocationChart.destroy();
            }

            setTimeout(() => { // Simulate loading delay
                const assetTypes = {};
                appData.investments.forEach(inv => {
                    const type = inv.type === 'Custom' ? inv.name : inv.type; // Group custom assets by their name for the chart
                    assetTypes[type] = (assetTypes[type] || 0) + (inv.currentValue || inv.value);
                });

                const labels = Object.keys(assetTypes);
                const data = Object.values(assetTypes);
                const currentTheme = appData.userProfile.theme;

                const backgroundColors = [
                    currentTheme === 'light' ? 'rgba(22, 163, 74, 0.8)' : 'rgba(0, 255, 136, 0.8)', // accent-700 / accent-500
                    currentTheme === 'light' ? 'rgba(21, 128, 61, 0.8)' : 'rgba(34, 197, 94, 0.8)',  // accent-800 / accent-600
                    'rgba(59, 130, 246, 0.8)', // blue-500
                    'rgba(234, 179, 8, 0.8)',  // yellow-500
                    'rgba(239, 68, 68, 0.8)'   // red-500
                ];
                const borderColors = [
                    currentTheme === 'light' ? 'rgba(22, 163, 74, 1)' : 'rgba(0, 255, 136, 1)',
                    currentTheme === 'light' ? 'rgba(21, 128, 61, 1)' : 'rgba(34, 197, 94, 1)',
                    'rgba(59, 130, 246, 1)',
                    'rgba(234, 179, 8, 1)',
                    'rgba(239, 68, 68, 1)'
                ];

                assetAllocationChart = new Chart(assetAllocationChartCanvas, {
                    type: 'pie',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: backgroundColors,
                            borderColor: borderColors,
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: {
                                    color: (appData.userProfile.theme === 'light' ? '#1a1a1a' : '#e5e5e5') // dynamic text color
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed !== null) {
                                            label += formatCurrencyIDR(context.parsed);
                                        }
                                        return label;
                                    }
                                }
                            },
                             animation: {
                                animateScale: true,
                                animateRotate: true
                            }
                        }
                    }
                });
                 assetAllocationSkeleton.classList.add('hidden');
            }, 500);
        };

        /**
         * Renders the cashflow chart.
         */
        const renderCashflowChart = () => {
            cashflowSkeleton.classList.remove('hidden');
            if (cashflowChart) {
                cashflowChart.destroy();
            }

            setTimeout(() => {
                const monthlyData = {};
                appData.transactions.forEach(t => {
                    const date = new Date(t.date);
                    const monthYear = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                    if (!monthlyData[monthYear]) {
                        monthlyData[monthYear] = { income: 0, expense: 0 };
                    }
                    if (t.type === 'income') {
                        monthlyData[monthYear].income += t.amount;
                    } else {
                        monthlyData[monthYear].expense += t.amount;
                    }
                });

                const sortedMonths = Object.keys(monthlyData).sort();
                const incomeData = sortedMonths.map(m => monthlyData[m].income);
                const expenseData = sortedMonths.map(m => monthlyData[m].expense);
                const currentTheme = appData.userProfile.theme;

                cashflowChart = new Chart(cashflowChartCanvas, {
                    type: 'bar',
                    data: {
                        labels: sortedMonths,
                        datasets: [
                            {
                                label: 'Pemasukan',
                                backgroundColor: currentTheme === 'light' ? 'rgba(22, 163, 74, 0.8)' : 'rgba(0, 255, 136, 0.8)',
                                borderColor: currentTheme === 'light' ? 'rgba(22, 163, 74, 1)' : 'rgba(0, 255, 136, 1)',
                                borderWidth: 1,
                                data: incomeData
                            },
                            {
                                label: 'Pengeluaran',
                                backgroundColor: currentTheme === 'light' ? 'rgba(220, 38, 38, 0.8)' : 'rgba(239, 68, 68, 0.8)',
                                borderColor: currentTheme === 'light' ? 'rgba(220, 38, 38, 1)' : 'rgba(239, 68, 68, 1)',
                                borderWidth: 1,
                                data: expenseData
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: {
                                    color: (currentTheme === 'light' ? '#1a1a1a' : '#e5e5e5')
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed.y !== null) {
                                            label += formatCurrencyIDR(context.parsed.y);
                                        }
                                        return label;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                ticks: {
                                    color: (currentTheme === 'light' ? '#1a1a1a' : '#e5e5e5')
                                },
                                grid: {
                                    color: (currentTheme === 'light' ? 'rgba(0,0,0,0.08)' : 'rgba(255,255,255,0.08)')
                                }
                            },
                            y: {
                                ticks: {
                                    color: (currentTheme === 'light' ? '#1a1a1a' : '#e5e5e5'),
                                    callback: function(value) {
                                        return formatCurrencyIDR(value);
                                    }
                                },
                                grid: {
                                    color: (currentTheme === 'light' ? 'rgba(0,0,0,0.08)' : 'rgba(255,255,255,0.08)')
                                }
                            }
                        },
                        animation: {
                            duration: 1000,
                            easing: 'easeOutQuart'
                        }
                    }
                });
                cashflowSkeleton.classList.add('hidden');
            }, 500);
        };

        /**
         * Renders the investments list.
         */
        const renderInvestments = () => {
            investmentsList.innerHTML = '';
            for (let i = 0; i < 2; i++) {
                const skeletonRow = document.createElement('tr');
                skeletonRow.className = 'skeleton-row';
                skeletonRow.innerHTML = `
                    <td class="px-6 py-4"><div class="h-4 w-3/4 skeleton"></div></td>
                    <td class="px-6 py-4"><div class="h-4 w-1/2 skeleton"></div></td>
                    <td class="px-6 py-4"><div class="h-4 w-1/3 skeleton"></div></td>
                    <td class="px-6 py-4"><div class="h-4 w-2/3 skeleton"></div></td>
                    <td class="px-6 py-4"><div class="h-4 w-1/2 skeleton"></div></td>
                    <td class="px-6 py-4"><div class="h-4 w-1/4 skeleton"></div></td>
                `;
                investmentsList.appendChild(skeletonRow);
            }

            setTimeout(() => {
                investmentsList.innerHTML = '';
                if (appData.investments.length === 0) {
                    investmentsList.innerHTML = `<tr><td colspan="6" class="px-6 py-4 whitespace-nowrap text-center text-current-text-tertiary">Belum ada data investasi. Tambahkan yang pertama!</td></tr>`;
                    return;
                }

                appData.investments.forEach(inv => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-current-bg-card-hover transition-colors duration-150 animate-listItemEnter';
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-current-text-primary">${inv.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-current-text-secondary">${inv.type}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-current-text-secondary">${formatNumberWithDots(inv.amount, inv.type === 'Kripto' ? 8 : 2)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-current-text-secondary">${formatCurrencyIDR(inv.value)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-current-text-primary font-semibold">${formatCurrencyIDR(inv.currentValue || inv.value)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium">
                            <button data-id="${inv.id}" class="update-investment-value-btn info-blue hover:text-info-blue mr-2" title="Perbarui Nilai Saat Ini" aria-label="Perbarui Nilai Aset ${inv.name}"><i class="fas fa-arrow-up-right-dots"></i></button>
                            <button data-id="${inv.id}" class="delete-investment-btn status-red hover:text-status-red" title="Hapus Aset" aria-label="Hapus Aset ${inv.name}"><i class="fas fa-trash-alt"></i></button>
                        </td>
                    `;
                    investmentsList.appendChild(row);
                });
            }, 500);
        };

        /**
         * Renders the savings goals and current savings.
         */
        const renderSavings = () => {
            savingGoalsList.innerHTML = '';
            for (let i = 0; i < 2; i++) {
                const skeletonDiv = document.createElement('div');
                skeletonDiv.className = 'flex items-center justify-between p-4 glass-card rounded-xl skeleton-row';
                skeletonDiv.innerHTML = `
                    <div class="flex-grow space-y-2">
                        <div class="h-6 w-3/4 skeleton"></div>
                        <div class="h-4 w-1/2 skeleton"></div>
                    </div>
                    <div class="w-24 h-2.5 skeleton"></div>
                `;
                savingGoalsList.appendChild(skeletonDiv);
            }

            // Clear previous dynamically added currency cards
            const existingDynamicCards = currencySavingsContainer.querySelectorAll('[data-dynamic-currency]');
            existingDynamicCards.forEach(card => card.remove());

            // Render IDR first (static)
            currentIdrSavingsEl.textContent = formatCurrencyIDR(appData.cashSavings.IDR || 0);

            // Render other custom currencies
            appData.customCurrencies.forEach(currency => {
                if (currency.code !== 'IDR') { // IDR is already handled
                    const currencyCard = document.createElement('div');
                    currencyCard.className = 'glass-card p-4 rounded-xl flex flex-col items-start';
                    currencyCard.dataset.dynamicCurrency = currency.code; // Mark as dynamic
                    currencyCard.innerHTML = `
                        <p class="text-current-text-tertiary text-lg mb-1">Tabungan Uang (${currency.code})</p>
                        <h3 class="text-3xl font-bold text-current-accent-main">${formatAmountWithSymbol(appData.cashSavings[currency.code] || 0, currency.code)}</h3>
                        <button data-currency="${currency.code}" class="add-funds-btn mt-2 bg-current-input-bg hover:bg-current-bg-card-hover text-current-text-primary text-sm py-1 px-3 rounded-lg focus:outline-none" aria-label="Tambah Dana ${currency.code}">Tambah Dana</button>
                        <button data-currency="${currency.code}" class="remove-currency-btn status-red hover:text-status-red text-sm mt-1" aria-label="Hapus Mata Uang ${currency.code}">Hapus Mata Uang</button>
                    `;
                    currencySavingsContainer.appendChild(currencyCard);
                }
            });

            // Re-attach event listeners for "Tambah Dana" buttons as they are dynamically created
            // Using event delegation on the container for robustness
            currencySavingsContainer.querySelectorAll('.add-funds-btn').forEach(button => {
                button.onclick = async (e) => { // Use onclick to re-assign as content might be replaced
                    const currencyType = e.target.dataset.currency;
                    const customCurrency = appData.customCurrencies.find(c => c.code === currencyType);
                    const currencySymbol = customCurrency ? customCurrency.symbol : '';

                    const { confirmed, value } = await showModal(
                        `Tambah Dana ke Tabungan Uang (${currencyType})`,
                        `Masukkan jumlah ${currencyType} yang ingin ditambahkan:`,
                        true,
                        `Jumlah ${currencyType}`,
                        'number' // Ensure number input type
                    );

                    if (confirmed && value !== null && value > 0) {
                        appData.cashSavings[currencyType] = (appData.cashSavings[currencyType] || 0) + value;
                        saveAppData();
                        renderSavings();
                        renderDashboardSummary();
                        showModal('Sukses', `Dana ${currencyType} berhasil ditambahkan!`);
                    } else if (confirmed && value !== null && value <= 0) {
                        showModal('Peringatan', 'Jumlah harus lebih besar dari nol.');
                    }
                };
            });

            // Attach event listener for "Hapus Mata Uang" buttons
            currencySavingsContainer.querySelectorAll('.remove-currency-btn').forEach(button => {
                button.onclick = async (e) => {
                    const currencyCodeToRemove = e.target.dataset.currency;
                    const { confirmed } = await showModal(
                        'Konfirmasi Hapus Mata Uang',
                        `Apakah Anda yakin ingin menghapus mata uang ${currencyCodeToRemove}? Semua tabungan dalam mata uang ini akan hilang.`,
                        false
                    );
                    if (confirmed) {
                        // Remove from customCurrencies
                        appData.customCurrencies = appData.customCurrencies.filter(c => c.code !== currencyCodeToRemove);
                        // Remove the savings amount for this currency
                        delete appData.cashSavings[currencyCodeToRemove];
                        saveAppData();
                        renderSavings(); // Re-render to reflect changes
                        renderDashboardSummary();
                        showModal('Dihapus', `Mata uang ${currencyCodeToRemove} berhasil dihapus.`);
                    }
                };
            });

            setTimeout(() => {
                savingGoalsList.innerHTML = '';
                if (appData.savingsGoals.length === 0) {
                    savingGoalsList.innerHTML = `<p class="text-center text-current-text-tertiary">Belum ada target tabungan. Ayo tetapkan yang pertama!</p>`;
                }

                appData.savingsGoals.forEach(goal => {
                    appData.emergencyFund.current = appData.cashSavings.IDR || 0; // Emergency fund always linked to IDR

                    const currentProgress = appData.cashSavings.IDR > goal.amount ? goal.amount : appData.cashSavings.IDR;
                    const percentage = goal.amount > 0 ? (currentProgress / goal.amount) * 100 : 0;
                    const progressColor = percentage >= 100 ? 'bg-status-green' : 'bg-current-accent-main';

                    const goalCard = document.createElement('div');
                    goalCard.className = 'glass-card p-4 rounded-xl flex items-center justify-between shadow-md animate-listItemEnter';
                    goalCard.innerHTML = `
                        <div>
                            <p class="text-lg font-semibold text-current-text-primary">${goal.name}</p>
                            <p class="text-sm text-current-text-secondary">Target: ${formatCurrencyIDR(goal.amount)}</p>
                            <p class="text-sm text-current-text-secondary">Dicapai: ${formatCurrencyIDR(currentProgress)}</p>
                        </div>
                        <div class="flex flex-col items-end space-y-2">
                            <div class="w-24 bg-current-input-bg rounded-full h-2.5">
                                <div id="progress-bar-${goal.id}" class="${progressColor} h-2.5 rounded-full transition-all duration-500" style="width: ${percentage}%"></div>
                            </div>
                            <span class="text-sm font-medium text-current-accent-main">${percentage.toFixed(2)}%</span>
                            <button data-id="${goal.id}" class="delete-goal-btn status-red hover:text-status-red text-sm" title="Hapus Target" aria-label="Hapus Target Tabungan ${goal.name}"><i class="fas fa-trash-alt mr-1"></i>Hapus</button>
                        </div>
                    `;
                    savingGoalsList.appendChild(goalCard);
                });


                // Render Emergency Fund
                emergencyFundTargetEl.textContent = formatCurrencyIDR(appData.emergencyFund.target);
                emergencyFundCurrentEl.textContent = formatCurrencyIDR(appData.emergencyFund.current);
                const emergencyPercentage = appData.emergencyFund.target > 0 ? (appData.emergencyFund.current / appData.emergencyFund.target) * 100 : 0;
                emergencyFundProgressBar.style.width = `${emergencyPercentage}%`;
                emergencyFundProgressBar.className = `h-2.5 rounded-full transition-all duration-500 ${emergencyPercentage >= 100 ? 'bg-status-green' : 'bg-current-accent-main'}`;
                emergencyFundPercentageEl.textContent = `${emergencyPercentage.toFixed(2)}%`;
                saveAppData();

            }, 500);
        };

        /**
         * Renders the transactions list based on current filters.
         */
        const renderTransactions = () => {
            transactionsList.innerHTML = '';
            for (let i = 0; i < 2; i++) {
                const skeletonRow = document.createElement('tr');
                skeletonRow.className = 'skeleton-row';
                skeletonRow.innerHTML = `
                    <td class="px-6 py-4"><div class="h-4 w-1/3 skeleton"></div></td>
                    <td class="px-6 py-4"><div class="h-4 w-1/4 skeleton"></div></td>
                    <td class="px-6 py-4"><div class="h-4 w-1/2 skeleton"></div></td>
                    <td class="px-6 py-4"><div class="h-4 w-1/3 skeleton"></div></td>
                    <td class="px-6 py-4"><div class="h-4 w-3/4 skeleton"></div></td>
                    <td class="px-6 py-4"><div class="h-4 w-1/4 skeleton"></div></td>
                `;
                transactionsList.appendChild(skeletonRow);
            }

            setTimeout(() => {
                transactionsList.innerHTML = '';
                if (appData.transactions.length === 0) {
                    transactionsList.innerHTML = `<tr><td colspan="6" class="px-6 py-4 whitespace-nowrap text-center text-current-text-tertiary">Belum ada riwayat transaksi yang cocok dengan filter.</td></tr>`;
                    return;
                }

                let filteredTransactions = [...appData.transactions].sort((a, b) => new Date(b.date) - new Date(a.date));

                const currentTimeFilter = filterTime.value;
                const currentTypeFilter = filterType.value;
                const now = new Date();

                filteredTransactions = filteredTransactions.filter(t => {
                    const transactionDate = new Date(t.date);
                    let passTimeFilter = true;
                    let passTypeFilter = true;

                    if (currentTimeFilter === 'week') {
                        const oneWeekAgo = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 7);
                        passTimeFilter = transactionDate >= oneWeekAgo && transactionDate <= now;
                    } else if (currentTimeFilter === 'month') {
                        passTimeFilter = transactionDate.getMonth() === now.getMonth() && transactionDate.getFullYear() === now.getFullYear();
                    } else if (currentTimeFilter === 'year') {
                        passTimeFilter = transactionDate.getFullYear() === now.getFullYear();
                    }

                    if (currentTypeFilter !== 'all') {
                        passTypeFilter = t.type === currentTypeFilter;
                    }

                    return passTimeFilter && passTypeFilter;
                });

                if (filteredTransactions.length === 0) {
                    transactionsList.innerHTML = `<tr><td colspan="6" class="px-6 py-4 whitespace-nowrap text-center text-current-text-tertiary">Belum ada riwayat transaksi yang cocok dengan filter.</td></tr>`;
                    return;
                }

                filteredTransactions.forEach(t => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-current-bg-card-hover transition-colors duration-150 animate-listItemEnter';
                    const amountClass = t.type === 'income' ? 'text-current-accent-main' : 'status-red';
                    const typeIcon = t.type === 'income' ? `<i class="fas fa-arrow-alt-circle-down text-current-accent-main"></i> Pemasukan` : `<i class="fas fa-arrow-alt-circle-up status-red"></i> Pengeluaran`;
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-current-text-secondary">${new Date(t.date).toLocaleDateString('id-ID')}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-current-text-secondary">${typeIcon}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-current-text-secondary">${t.category}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-semibold ${amountClass}">${formatCurrencyIDR(t.amount)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-current-text-secondary">${t.description || '-'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium">
                            <button data-id="${t.id}" class="edit-transaction-btn info-blue hover:text-info-blue mr-2" title="Edit Transaksi" aria-label="Edit Transaksi ${t.category}"><i class="fas fa-edit"></i></button>
                            <button data-id="${t.id}" class="delete-transaction-btn status-red hover:text-status-red" title="Hapus Transaksi" aria-label="Hapus Transaksi ${t.category}"><i class="fas fa-trash-alt"></i></button>
                        </td>
                    `;
                    transactionsList.appendChild(row);
                });
            }, 500);
        };

        /**
         * Renders the budget list.
         */
        const renderBudgets = () => {
            budgetList.innerHTML = '';
            currentMonthBudgetSummary.innerHTML = `<p class="text-center text-current-text-tertiary">Belum ada anggaran yang ditetapkan untuk bulan ini.</p>`;

            const now = new Date();
            const currentMonthKey = `${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}`;

            const currentMonthBudget = appData.budgets.find(b => b.month === currentMonthKey);
            let currentMonthExpenses = 0;

            if (currentMonthBudget) {
                currentMonthExpenses = appData.transactions.filter(t => {
                    const tDate = new Date(t.date);
                    return t.type === 'expense' && tDate.getFullYear() === now.getFullYear() && tDate.getMonth() === now.getMonth();
                }).reduce((sum, t) => sum + t.amount, 0);

                const remainingCurrent = currentMonthBudget.amount - currentMonthExpenses;
                const percentageUsedCurrent = currentMonthBudget.amount > 0 ? (currentMonthExpenses / currentMonthBudget.amount) * 100 : 0;
                const progressBarColorCurrent = percentageUsedCurrent >= 100 ? 'bg-status-red' : (percentageUsedCurrent >= 80 ? 'bg-status-yellow' : 'bg-current-accent-main');

                currentMonthBudgetSummary.innerHTML = `
                    <div class="flex flex-col md:flex-row items-start md:items-center justify-between">
                        <div class="flex-grow mb-4 md:mb-0">
                            <p class="text-lg font-semibold text-current-text-primary">Anggaran Bulan Ini: ${formatCurrencyIDR(currentMonthBudget.amount)}</p>
                            <p class="text-sm text-current-text-secondary">Terpakai: ${formatCurrencyIDR(currentMonthExpenses)}</p>
                            <p class="text-sm text-current-text-secondary">Sisa: <span class="${remainingCurrent < 0 ? 'status-red' : 'text-current-accent-main'}">${formatCurrencyIDR(remainingCurrent)}</span></p>
                        </div>
                        <div class="flex flex-col items-end space-y-2 w-full md:w-auto">
                            <div class="w-full md:w-36 bg-current-input-bg rounded-full h-2.5">
                                <div id="budget-progress-bar-${currentMonthBudget.id}" class="${progressBarColorCurrent} h-2.5 rounded-full transition-all duration-500" style="width: ${percentageUsedCurrent > 100 ? 100 : percentageUsedCurrent}%"></div>
                            </div>
                            <span class="text-sm font-medium ${percentageUsedCurrent >= 100 ? 'status-red' : 'text-current-accent-main'}">${percentageUsedCurrent.toFixed(2)}% Terpakai</span>
                        </div>
                    </div>
                `;
            }


            if (appData.budgets.length === 0) {
                budgetList.innerHTML = `<p class="text-center text-current-text-tertiary">Belum ada riwayat anggaran yang ditetapkan.</p>`;
                return;
            }

            const sortedBudgets = [...appData.budgets].sort((a, b) => {
                const dateA = new Date(a.month);
                const dateB = new Date(b.month);
                return dateB - dateA;
            });

            sortedBudgets.forEach(budget => {
                const budgetDate = new Date(budget.month);
                const year = budgetDate.getFullYear();
                const monthName = new Date(year, budgetDate.getMonth()).toLocaleString('id-ID', { month: 'long' });

                const monthlyExpenses = appData.transactions.filter(t => {
                    const tDate = new Date(t.date);
                    return t.type === 'expense' && tDate.getFullYear() === year && tDate.getMonth() === budgetDate.getMonth();
                }).reduce((sum, t) => sum + t.amount, 0);

                const remaining = budget.amount - monthlyExpenses;
                const percentageUsed = budget.amount > 0 ? (monthlyExpenses / budget.amount) * 100 : 0;
                const progressBarColor = percentageUsed >= 100 ? 'bg-status-red' : (percentageUsed >= 80 ? 'bg-status-yellow' : 'bg-current-accent-main');


                const budgetCard = document.createElement('div');
                budgetCard.className = 'glass-card p-4 rounded-xl flex flex-col md:flex-row items-start md:items-center justify-between shadow-md animate-listItemEnter';
                budgetCard.innerHTML = `
                    <div class="flex-grow mb-4 md:mb-0">
                        <p class="text-lg font-semibold text-current-text-primary">Anggaran ${monthName} ${year}</p>
                        <p class="text-sm text-current-text-secondary">Anggaran: ${formatCurrencyIDR(budget.amount)}</p>
                        <p class="text-sm text-current-text-secondary">Terpakai: ${formatCurrencyIDR(monthlyExpenses)}</p>
                        <p class="text-sm text-current-text-secondary">Sisa: <span class="${remaining < 0 ? 'status-red' : 'text-current-accent-main'}">${formatCurrencyIDR(remaining)}</span></p>
                    </div>
                    <div class="flex flex-col items-end space-y-2 w-full md:w-auto">
                        <div class="w-full md:w-36 bg-current-input-bg rounded-full h-2.5">
                            <div class="${progressBarColor} h-2.5 rounded-full transition-all duration-500" style="width: ${percentageUsed > 100 ? 100 : percentageUsed}%"></div>
                        </div>
                        <span class="text-sm font-medium ${percentageUsed >= 100 ? 'status-red' : 'text-current-accent-main'}">${percentageUsed.toFixed(2)}% Terpakai</span>
                        <button data-id="${budget.id}" class="delete-budget-btn status-red hover:text-status-red text-sm" aria-label="Hapus Anggaran"><i class="fas fa-trash-alt mr-1"></i>Hapus</button>
                    </div>
                `;
                budgetList.appendChild(budgetCard);
            });
        };

        /**
         * Renders the bill reminders list.
         */
        const renderBillReminders = () => {
            billsList.innerHTML = '';
            if (appData.billReminders.length === 0) {
                billsList.innerHTML = `<p class="text-center text-current-text-tertiary">Belum ada tagihan yang ditambahkan.</p>`;
                return;
            }

            let filteredBills = [...appData.billReminders];
            const currentFilter = filterBills.value;
            const now = new Date();

            if (currentFilter === 'upcoming') {
                filteredBills = filteredBills.filter(bill => !bill.paid || new Date(bill.dueDate) >= now);
            }

            const sortedBills = filteredBills.sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));


            if (sortedBills.length === 0) {
                billsList.innerHTML = `<p class="text-center text-current-text-tertiary">Tidak ada tagihan yang cocok dengan filter Anda.</p>`;
                return;
            }

            sortedBills.forEach(bill => {
                const dueDate = new Date(bill.dueDate);
                const isOverdue = dueDate < now && !bill.paid && (dueDate.toDateString() !== now.toDateString());
                const statusClass = isOverdue ? 'status-red' : (bill.paid ? 'text-current-text-tertiary line-through' : 'text-current-accent-main');
                const statusText = isOverdue ? 'Jatuh Tempo!' : (bill.paid ? 'Terbayar' : 'Akan Datang');
                const cardClass = bill.paid ? 'opacity-70' : '';

                const billCard = document.createElement('div');
                billCard.className = `glass-card p-4 rounded-xl flex flex-col md:flex-row items-start md:items-center justify-between shadow-md animate-listItemEnter ${cardClass}`;
                billCard.innerHTML = `
                    <div class="flex-grow mb-4 md:mb-0">
                        <p class="text-lg font-semibold text-current-text-primary">${bill.name}</p>
                        <p class="text-sm text-current-text-secondary">Jumlah: ${formatCurrencyIDR(bill.amount)}</p>
                        <p class="text-sm ${statusClass}">Jatuh Tempo: ${dueDate.toLocaleDateString('id-ID')} (<span class="font-bold">${statusText}</span>)</p>
                        <p class="text-sm text-current-text-tertiary">Frekuensi: ${bill.frequency}</p>
                    </div>
                    <div class="flex flex-row md:flex-col items-center md:items-end space-x-2 md:space-x-0 md:space-y-2">
                        ${bill.paid ?
                            `<button data-id="${bill.id}" class="mark-unpaid-bill-btn bg-current-input-bg hover:bg-current-bg-card-hover text-current-text-secondary text-sm py-1 px-3 rounded-lg focus:outline-none mr-2 md:mr-0" aria-label="Tandai Belum Dibayar"><i class="fas fa-undo mr-1"></i>Belum Bayar</button>` :
                            `<button data-id="${bill.id}" class="mark-paid-bill-btn bg-current-accent-hover hover:bg-current-accent-dark text-current-text-primary text-sm py-1 px-3 rounded-lg focus:outline-none mr-2 md:mr-0" aria-label="Tandai Sudah Dibayar"><i class="fas fa-check-circle mr-1"></i>Bayar</button>`
                        }
                        <button data-id="${bill.id}" class="delete-bill-btn status-red hover:text-status-red text-sm" aria-label="Hapus Tagihan"><i class="fas fa-trash-alt mr-1"></i>Hapus</button>
                    </div>
                `;
                billsList.appendChild(billCard);
            });
        };

        /**
         * Renders the debts list.
         */
        const renderDebts = () => {
            debtsList.innerHTML = '';
            if (appData.debts.length === 0) {
                debtsList.innerHTML = `<tr><td colspan="5" class="px-6 py-4 whitespace-nowrap text-center text-current-text-tertiary">Belum ada utang yang ditambahkan.</td></tr>`;
                return;
            }

            const sortedDebts = [...appData.debts].sort((a, b) => b.currentBalance - a.currentBalance);

            sortedDebts.forEach(debt => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-current-bg-card-hover transition-colors duration-150 animate-listItemEnter';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-current-text-primary">${debt.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-current-text-secondary">${formatCurrencyIDR(debt.originalAmount)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold status-red">${formatCurrencyIDR(debt.currentBalance)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-current-text-secondary">${debt.interestRate}%</td>
                    <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium">
                        <button data-id="${debt.id}" class="make-payment-btn info-blue hover:text-info-blue mr-2" title="Bayar Utang" aria-label="Bayar Utang ${debt.name}"><i class="fas fa-money-check-alt"></i></button>
                        <button data-id="${debt.id}" class="delete-debt-btn status-red hover:text-status-red" title="Hapus Utang" aria-label="Hapus Utang ${debt.name}"><i class="fas fa-trash-alt"></i></button>
                    </td>
                `;
                debtsList.appendChild(row);
            });
        };


        /**
         * Activates a specific section and updates the page title.
         * @param {string} sectionId - The ID of the section to activate (e.g., 'dashboard-section').
         */
        const activateSection = (sectionId) => {
            sections.forEach(section => {
                section.classList.add('hidden');
                section.classList.remove('active-section');
            });
            const activeSection = document.getElementById(sectionId);
            if (activeSection) {
                activeSection.classList.remove('hidden');
                activeSection.classList.add('active-section');
                activeSection.classList.add('animate-fadeInUp');

                const navLinkElement = document.querySelector(`.nav-link[data-section="${sectionId.replace('-section', '')}"] span`);
                if (navLinkElement) {
                    pageTitle.textContent = navLinkElement.textContent.trim();
                } else if (sectionId === 'settings-section') {
                    pageTitle.textContent = 'Pengaturan';
                } else if (sectionId === 'budget-section') {
                     pageTitle.textContent = 'Anggaran';
                } else if (sectionId === 'bills-section') {
                     pageTitle.textContent = 'Tagihan';
                } else if (sectionId === 'debts-section') {
                    pageTitle.textContent = 'Manajemen Utang';
                } else if (sectionId === 'tools-section') {
                     pageTitle.textContent = 'Alat Keuangan';
                }
                else {
                    pageTitle.textContent = sectionId.replace('-section', '').replace(/-/g, ' ').split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
                }

                if (sectionId === 'dashboard-section') {
                    renderDashboardSummary();
                    renderAssetAllocationChart();
                    renderCashflowChart();
                } else if (sectionId === 'investments-section') {
                    renderInvestments();
                } else if (sectionId === 'savings-section') {
                    renderSavings();
                } else if (sectionId === 'transactions-section') {
                    renderTransactions();
                } else if (sectionId === 'budget-section') {
                    renderBudgets();
                } else if (sectionId === 'bills-section') {
                    renderBillReminders();
                } else if (sectionId === 'debts-section') {
                    renderDebts();
                }
                else if (sectionId === 'tools-section') {
                    compoundResultEl.textContent = formatCurrencyIDR(0);
                    retirementResultEl.textContent = formatCurrencyIDR(0);
                    conversionResultEl.textContent = '0';
                    riskResultEl.textContent = 'Tidak Diketahui';
                }
            }
        };

        // --- Event Listeners ---

        // Sidebar Toggles
        sidebarToggleOpen.addEventListener('click', () => {
            sidebar.classList.remove('-translate-x-full');
            sidebar.classList.add('translate-x-0');
            if (window.innerWidth >= 768) { // Only apply margin on desktop
                mainContent.classList.remove('sidebar-collapsed-margin');
                mainContent.classList.add('sidebar-expanded-margin');
            }
        });

        sidebarToggleClose.addEventListener('click', () => {
            sidebar.classList.add('-translate-x-full');
            sidebar.classList.remove('translate-x-0');
            if (window.innerWidth >= 768) { // Only apply margin on desktop
                mainContent.classList.remove('sidebar-expanded-margin');
                mainContent.classList.add('sidebar-collapsed-margin');
            } else { // On mobile, clear margin when sidebar is closed
                 mainContent.classList.remove('sidebar-expanded-margin', 'sidebar-collapsed-margin');
            }
        });

        // Event listener for desktop hover effect on sidebar
        sidebar.addEventListener('mouseenter', () => {
            if (window.innerWidth >= 768) {
                mainContent.classList.remove('sidebar-collapsed-margin');
                mainContent.classList.add('sidebar-expanded-margin');
            }
        });

        sidebar.addEventListener('mouseleave', () => {
            if (window.innerWidth >= 768) {
                mainContent.classList.remove('sidebar-expanded-margin');
                mainContent.classList.add('sidebar-collapsed-margin');
            }
        });


        // Navigation Links
        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const section = link.dataset.section + '-section';
                activateSection(section);
                if (window.innerWidth < 768) {
                    sidebar.classList.add('-translate-x-full');
                    sidebar.classList.remove('translate-x-0');
                    mainContent.classList.remove('sidebar-expanded-margin', 'sidebar-collapsed-margin'); // Clear margins on mobile when closing sidebar
                }
            });
        });

        // Settings Button in Header
        document.getElementById('settings-button').addEventListener('click', () => {
            activateSection('settings-section');
        });

        // Profile Avatar Click (to open edit profile modal)
        profileAvatar.addEventListener('click', () => {
            profileNameInput.value = appData.userProfile.name;
            updateProfileDisplay(); // Update modal's photo/initials
            profileEditModal.classList.remove('hidden');
        });

        // Profile Modal Cancel
        profileModalCancelBtn.addEventListener('click', () => {
            profileEditModal.classList.add('hidden');
        });

        // Profile Modal Save
        profileModalSaveBtn.addEventListener('click', () => {
            const newName = profileNameInput.value.trim();
            if (newName) {
                appData.userProfile.name = newName;
                const nameParts = newName.split(' ').filter(n => n);
                if (nameParts.length > 1) {
                    appData.userProfile.initials = (nameParts[0][0] + nameParts[nameParts.length - 1][0]).toUpperCase();
                } else if (nameParts.length === 1) {
                    appData.userProfile.initials = nameParts[0][0].toUpperCase();
                } else {
                    appData.userProfile.initials = 'AU';
                }
                saveAppData();
                updateProfileDisplay();
                profileEditModal.classList.add('hidden');
                showModal('Profil Diperbarui', 'Nama profil Anda berhasil diperbarui!');
            } else {
                showModal('Peringatan', 'Nama profil tidak boleh kosong.');
            }
        });

        // Profile Photo Upload Handler
        profilePhotoUpload.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                // Limit file size to prevent LocalStorage issues (e.g., 500KB)
                if (file.size > 500 * 1024) { // 500KB
                    showModal('Ukuran File Terlalu Besar', 'Ukuran foto profil tidak boleh melebihi 500KB.');
                    profilePhotoUpload.value = ''; // Clear the input
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    appData.userProfile.profilePhotoUrl = e.target.result;
                    saveAppData();
                    updateProfileDisplay(); // Update display in header and modal
                    showModal('Foto Diunggah', 'Foto profil berhasil diunggah!');
                };
                reader.readAsDataURL(file);
            }
        });

        // Remove Profile Photo Button
        removeProfilePhotoBtn.addEventListener('click', async () => {
            const { confirmed } = await showModal('Konfirmasi Hapus Foto', 'Apakah Anda yakin ingin menghapus foto profil?');
            if (confirmed) {
                appData.userProfile.profilePhotoUrl = null;
                saveAppData();
                updateProfileDisplay();
                showModal('Foto Dihapus', 'Foto profil berhasil dihapus.');
            }
        });

        // Add Investment Form
        addInvestmentForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const assetType = formData.get('type');
            const assetValue = parseNumberFromFormattedString(document.getElementById('asset-value').value);
            let assetAmount = parseNumberFromFormattedString(document.getElementById('asset-amount').value); // Get user input amount or calculated one
            const assetPricePerUnit = parseNumberFromFormattedString(document.getElementById('asset-price-per-unit').value);

            // If it's crypto and pricePerUnit and value are provided, prioritize calculated amount
            if (assetType === 'Kripto' && assetValue > 0 && assetPricePerUnit > 0) {
                assetAmount = assetValue / assetPricePerUnit;
            }

            const newInvestment = {
                id: generateId(),
                name: formData.get('name'),
                type: assetType,
                amount: assetAmount, // Use the parsed/calculated amount
                value: assetValue, // Use parsed value
                currentValue: assetValue,
                pricePerUnit: assetType === 'Kripto' ? assetPricePerUnit : null
            };

            appData.investments.push(newInvestment);
            saveAppData();
            renderInvestments();
            renderDashboardSummary();
            renderAssetAllocationChart();
            e.target.reset();
            showModal('Sukses', 'Aset investasi berhasil ditambahkan!');
            // After reset, ensure crypto fields are hidden and calculation is reset if type is not crypto
            assetTypeSelect.dispatchEvent(new Event('change'));
        });

        // Dynamic display for asset price per unit input
        assetTypeSelect.addEventListener('change', () => {
            if (assetTypeSelect.value === 'Kripto') {
                assetPricePerUnitGroup.classList.remove('hidden');
                // Re-apply formatter for pricePerUnit to ensure it handles high precision
                applyCurrencyInputFormatting(assetPricePerUnitInput, 8);
                // Also ensure amount input is ready for high precision if calculated
                applyCurrencyInputFormatting(document.getElementById('asset-amount'), 8);
            } else {
                assetPricePerUnitGroup.classList.add('hidden');
                assetPricePerUnitInput.value = ''; // Clear value when hidden
                // Revert asset-amount formatting to default currency precision
                applyCurrencyInputFormatting(document.getElementById('asset-amount'), 2);
            }
            calculateCryptoAmount(); // Recalculate if asset type changes
        });

        // Crypto price/amount calculation logic (on input for value or price)
        document.getElementById('asset-value').addEventListener('input', calculateCryptoAmount);
        assetPricePerUnitInput.addEventListener('input', calculateCryptoAmount); // Use global variable here

        // Investment List Actions (Update Value/Delete) - Event Delegation
        investmentsList.addEventListener('click', async (e) => {
            const target = e.target.closest('button');
            if (!target) return;

            const id = target.dataset.id;
            if (target.classList.contains('delete-investment-btn')) {
                const { confirmed } = await showModal('Konfirmasi Hapus', 'Apakah Anda yakin ingin menghapus aset investasi ini?');
                if (confirmed) {
                    appData.investments = appData.investments.filter(inv => inv.id !== id);
                    saveAppData();
                    renderInvestments();
                    renderDashboardSummary();
                    renderAssetAllocationChart();
                    showModal('Dihapus', 'Aset investasi berhasil dihapus.');
                }
            } else if (target.classList.contains('update-investment-value-btn')) {
                const investmentToUpdate = appData.investments.find(inv => inv.id === id);
                if (investmentToUpdate) {
                    const { confirmed, value } = await showModal(
                        'Perbarui Nilai Saat Ini',
                        `Masukkan nilai terbaru untuk ${investmentToUpdate.name} (Acquisition: ${formatCurrencyIDR(investmentToUpdate.value)}):`,
                        true,
                        'Nilai saat ini (IDR)',
                        'number'
                    );
                    if (confirmed && value !== null) {
                        investmentToUpdate.currentValue = value;
                        saveAppData();
                        renderInvestments();
                        renderDashboardSummary();
                        renderAssetAllocationChart();
                        showModal('Sukses', 'Nilai aset berhasil diperbarui.');
                    }
                }
            }
        });


        // Add Saving Goal Form
        addSavingGoalForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const newGoal = {
                id: generateId(),
                name: formData.get('name'),
                amount: parseNumberFromFormattedString(document.getElementById('goal-amount').value),
            };

            appData.savingsGoals.push(newGoal);
            saveAppData();
            renderSavings();
            showModal('Sukses', 'Target tabungan berhasil ditambahkan!');
            e.target.reset();
        });

        // Savings List Actions (Delete Goal) - Event Delegation
        savingGoalsList.addEventListener('click', async (e) => {
            const target = e.target.closest('button');
            if (!target) return;

            const id = target.dataset.id;
            if (target.classList.contains('delete-goal-btn')) {
                const { confirmed } = await showModal('Konfirmasi Hapus', 'Apakah Anda yakin ingin menghapus target tabungan ini?');
                if (confirmed) {
                    appData.savingsGoals = appData.savingsGoals.filter(goal => goal.id !== id);
                    saveAppData();
                    renderSavings();
                    showModal('Dihapus', 'Target tabungan berhasil dihapus.');
                }
            }
        });

        // Set Emergency Fund
        setEmergencyFundBtn.addEventListener('click', async () => {
            const { confirmed, value } = await showModal(
                'Atur Target Dana Darurat',
                'Masukkan target dana darurat Anda (IDR):',
                true,
                'Target jumlah (IDR)',
                'number'
            );
            if (confirmed && value !== null && value >= 0) {
                appData.emergencyFund.target = value;
                saveAppData();
                renderSavings();
                showModal('Sukses', 'Target dana darurat berhasil diperbarui.');
            } else if (confirmed && value !== null && value < 0) {
                showModal('Peringatan', 'Target harus nol atau lebih.');
            }
        });


        // Add Transaction Form
        addTransactionForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const newTransaction = {
                id: generateId(),
                type: formData.get('type'),
                category: formData.get('category'),
                amount: parseNumberFromFormattedString(document.getElementById('transaction-amount').value),
                date: formData.get('date'),
                description: formData.get('description')
            };

            appData.transactions.push(newTransaction);
            saveAppData();
            renderTransactions();
            renderCashflowChart();
            renderBudgets();
            renderDashboardSummary();
            showModal('Sukses', 'Transaksi berhasil ditambahkan!');
            e.target.reset();
        });

        // Transaction List Filters and Actions (Edit/Delete) - Event Delegation
        filterTime.addEventListener('change', renderTransactions);
        filterType.addEventListener('change', renderTransactions);

        transactionsList.addEventListener('click', async (e) => {
            const target = e.target.closest('button');
            if (!target) return;

            const id = target.dataset.id;
            if (target.classList.contains('delete-transaction-btn')) {
                const { confirmed } = await showModal('Konfirmasi Hapus', 'Apakah Anda yakin ingin menghapus transaksi ini?');
                if (confirmed) {
                    appData.transactions = appData.transactions.filter(t => t.id !== id);
                    saveAppData();
                    renderTransactions();
                    renderCashflowChart();
                    renderBudgets();
                    renderDashboardSummary();
                    showModal('Dihapus', 'Transaksi berhasil dihapus.');
                }
            } else if (target.classList.contains('edit-transaction-btn')) {
                const transactionToEdit = appData.transactions.find(t => t.id === id);
                if (transactionToEdit) {
                    const { confirmed, value } = await showModal(
                        'Edit Jumlah Transaksi',
                        `Masukkan jumlah baru untuk transaksi "${transactionToEdit.category}" (${transactionToEdit.type === 'income' ? 'Pemasukan' : 'Pengeluaran'}):`,
                        true,
                        'Jumlah baru (IDR)',
                        'number'
                    );
                    if (confirmed && value !== null) {
                        transactionToEdit.amount = value;
                        saveAppData();
                        renderTransactions();
                        renderCashflowChart();
                        renderBudgets();
                        renderDashboardSummary();
                        showModal('Sukses', 'Jumlah transaksi berhasil diperbarui.');
                    }
                }
            }
        });

        // Set Budget Form
        setBudgetForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const month = formData.get('month');
            const amount = parseNumberFromFormattedString(document.getElementById('budget-amount').value);

            const existingBudgetIndex = appData.budgets.findIndex(b => b.month === month);

            if (existingBudgetIndex > -1) {
                showModal('Peringatan', 'Anggaran untuk bulan ini sudah ada. Anda bisa menghapusnya terlebih dahulu jika ingin mengatur ulang.');
            } else {
                const newBudget = {
                    id: generateId(),
                    month: month,
                    amount: amount
                };
                appData.budgets.push(newBudget);
                saveAppData();
                renderBudgets();
                showModal('Sukses', 'Anggaran berhasil ditetapkan!');
                e.target.reset();
            }
        });

        // Budget List Actions (Delete)
        budgetList.addEventListener('click', async (e) => {
            const target = e.target.closest('button');
            if (!target) return;

            const id = target.dataset.id;
            if (target.classList.contains('delete-budget-btn')) {
                const { confirmed } = await showModal('Konfirmasi Hapus', 'Apakah Anda yakin ingin menghapus anggaran ini?');
                if (confirmed) {
                    appData.budgets = appData.budgets.filter(b => b.id !== id);
                    saveAppData();
                    renderBudgets();
                    showModal('Dihapus', 'Anggaran berhasil dihapus.');
                }
            }
        });

        // Add Bill Form
        addBillForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const newBill = {
                id: generateId(),
                name: formData.get('name'),
                amount: parseNumberFromFormattedString(document.getElementById('bill-amount').value),
                dueDate: formData.get('dueDate'),
                frequency: formData.get('frequency'),
                paid: false
            };

            appData.billReminders.push(newBill);
            saveAppData();
            renderBillReminders();
            showModal('Sukses', 'Pengingat tagihan berhasil ditambahkan!');
            e.target.reset();
        });

        // Bills List Actions (Mark Paid/Unpaid/Delete)
        filterBills.addEventListener('change', renderBillReminders);

        billsList.addEventListener('click', async (e) => {
            const target = e.target.closest('button');
            if (!target) return;

            const id = target.dataset.id;
            const billIndex = appData.billReminders.findIndex(b => b.id === id);

            if (billIndex === -1) return;

            if (target.classList.contains('mark-paid-bill-btn')) {
                const { confirmed } = await showModal('Konfirmasi Pembayaran', `Apakah Anda yakin sudah membayar tagihan "${appData.billReminders[billIndex].name}"?`);
                if (confirmed) {
                    appData.billReminders[billIndex].paid = true;
                    saveAppData();
                    renderBillReminders();
                    showModal('Sukses', 'Tagihan ditandai sudah dibayar.');
                }
            } else if (target.classList.contains('mark-unpaid-bill-btn')) {
                 const { confirmed } = await showModal('Konfirmasi Batal Bayar', `Apakah Anda yakin ingin menandai tagihan "${appData.billReminders[billIndex].name}" sebagai belum dibayar?`);
                if (confirmed) {
                    appData.billReminders[billIndex].paid = false;
                    saveAppData();
                    renderBillReminders();
                    showModal('Sukses', 'Tagihan ditandai belum dibayar.');
                }
            }
            else if (target.classList.contains('delete-bill-btn')) {
                const { confirmed } = await showModal('Konfirmasi Hapus', 'Apakah Anda yakin ingin menghapus pengingat tagihan ini?');
                if (confirmed) {
                    appData.billReminders.splice(billIndex, 1);
                    saveAppData();
                    renderBillReminders();
                    showModal('Dihapus', 'Pengingat tagihan berhasil dihapus.');
                }
            }
        });

        // Add Debt Form
        addDebtForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const newDebt = {
                id: generateId(),
                name: formData.get('name'),
                originalAmount: parseNumberFromFormattedString(document.getElementById('debt-original-amount').value),
                currentBalance: parseNumberFromFormattedString(document.getElementById('debt-current-balance').value),
                interestRate: parseNumberFromFormattedString(document.getElementById('debt-interest-rate').value),
            };

            appData.debts.push(newDebt);
            saveAppData();
            renderDebts();
            renderDashboardSummary();
            showModal('Sukses', 'Utang berhasil ditambahkan!');
            e.target.reset();
        });

        // Debts List Actions (Make Payment/Delete)
        debtsList.addEventListener('click', async (e) => {
            const target = e.target.closest('button');
            if (!target) return;

            const id = target.dataset.id;
            const debtIndex = appData.debts.findIndex(d => d.id === id);

            if (debtIndex === -1) return;

            if (target.classList.contains('make-payment-btn')) {
                const debtToPay = appData.debts[debtIndex];
                const { confirmed, value } = await showModal(
                    'Lakukan Pembayaran',
                    `Masukkan jumlah pembayaran untuk "${debtToPay.name}" (Saldo Saat Ini: ${formatCurrencyIDR(debtToPay.currentBalance)}):`,
                    true,
                    'Jumlah Pembayaran (IDR)',
                    'number'
                );
                if (confirmed && value !== null && value > 0) {
                    debtToPay.currentBalance = Math.max(0, debtToPay.currentBalance - value);
                    saveAppData();
                    renderDebts();
                    renderDashboardSummary();
                    showModal('Sukses', 'Pembayaran berhasil dicatat.');
                } else if (confirmed && value !== null && value <= 0) {
                    showModal('Peringatan', 'Jumlah pembayaran harus lebih besar dari nol.');
                }
            } else if (target.classList.contains('delete-debt-btn')) {
                const { confirmed } = await showModal('Konfirmasi Hapus', 'Apakah Anda yakin ingin menghapus utang ini? Ini akan menghapusnya secara permanen.');
                if (confirmed) {
                    appData.debts.splice(debtIndex, 1);
                    saveAppData();
                    renderDebts();
                    renderDashboardSummary();
                    showModal('Dihapus', 'Utang berhasil dihapus.');
                }
            }
        });


        // Compound Interest Calculator Logic
        calculateCompoundBtn.addEventListener('click', () => {
            const principal = parseNumberFromFormattedString(principalInput.value);
            const annualRate = parseNumberFromFormattedString(annualRateInput.value) / 100;
            const years = parseNumberFromFormattedString(yearsInput.value);
            const compoundFrequency = parseNumberFromFormattedString(compoundFrequencySelect.value);

            if (isNaN(principal) || isNaN(annualRate) || isNaN(years) || isNaN(compoundFrequency) || principal < 0 || annualRate < 0 || years < 0) {
                showModal('Input Tidak Valid', 'Harap masukkan semua nilai dengan benar (angka positif).');
                return;
            }

            const futureValue = principal * Math.pow((1 + annualRate / compoundFrequency), (compoundFrequency * years));
            compoundResultEl.textContent = formatCurrencyIDR(futureValue);
        });

        // Retirement Calculator Logic
        calculateRetirementBtn.addEventListener('click', () => {
            const currentAge = parseNumberFromFormattedString(currentAgeInput.value);
            const retirementAge = parseNumberFromFormattedString(retirementAgeInput.value);
            let currentSavings = parseNumberFromFormattedString(currentRetirementSavingsInput.value);
            const annualContribution = parseNumberFromFormattedString(annualContributionInput.value);
            const estimatedReturn = parseNumberFromFormattedString(estimatedReturnInput.value) / 100;

            if (isNaN(currentAge) || isNaN(retirementAge) || isNaN(currentSavings) || isNaN(annualContribution) || isNaN(estimatedReturn) ||
                currentAge < 0 || retirementAge < currentAge || currentSavings < 0 || annualContribution < 0 || estimatedReturn < 0) {
                showModal('Input Tidak Valid', 'Harap masukkan semua nilai dengan benar (angka positif, usia pensiun > usia saat ini).');
                return;
            }

            const yearsToRetirement = retirementAge - currentAge;
            let projectedSavings = currentSavings;

            for (let i = 0; i < yearsToRetirement; i++) {
                projectedSavings = projectedSavings * (1 + estimatedReturn) + annualContribution;
            }

            retirementResultEl.textContent = formatCurrencyIDR(projectedSavings);
        });

        // Currency Converter Logic
        convertCurrencyBtn.addEventListener('click', () => {
            const amount = parseNumberFromFormattedString(fromCurrencyAmountInput.value);
            const fromCur = fromCurrencySelect.value;
            const toCur = toCurrencySelect.value;

            if (isNaN(amount) || amount < 0) {
                showModal('Input Tidak Valid', 'Harap masukkan jumlah yang valid.');
                return;
            }

            const convertedAmount = convertCurrency(amount, fromCur, toCur);
            conversionResultEl.textContent = formatAmountWithSymbol(convertedAmount, toCur);
        });

        // Risk Calculator Logic (Simulated)
        calculateRiskBtn.addEventListener('click', () => {
            const q1 = parseNumberFromFormattedString(riskQ1Select.value);
            const q2 = parseNumberFromFormattedString(riskQ2Select.value);

            let score = q1 + q2;
            let riskProfile = 'Tidak Diketahui';

            if (score <= 3) {
                riskProfile = 'Konservatif';
            } else if (score <= 6) {
                riskProfile = 'Moderasi';
            } else if (q1 >= 5 && q2 === 3) { // Adjusted logic for aggressive if needed, or simplify
                riskProfile = 'Agresif';
            } else {
                riskProfile = 'Agresif';
            }
            riskResultEl.textContent = riskProfile;
            showModal('Profil Risiko Anda', `Berdasarkan jawaban Anda, profil risiko Anda adalah: ${riskProfile}.`);
        });


        // Export Data
        exportDataBtn.addEventListener('click', () => {
            const dataToExport = JSON.parse(JSON.stringify(appData)); // Deep copy
            // For client-side export, include plaintext PIN if known, to enable import verification
            // This exposes the PIN in the exported file, a known trade-off for client-side functionality.
            if (sessionStorage.getItem('currentPlaintextPin')) {
                dataToExport.userProfile.pin = sessionStorage.getItem('currentPlaintextPin');
            } else {
                // If the user has not authenticated this session, their plaintext PIN isn't available
                // for export. The exported data will NOT include the 'pin' field,
                // and importing it later will not require PIN verification.
                showModal('Peringatan Ekspor', 'PIN Anda tidak dapat disertakan dalam ekspor ini karena sesi ini tidak diverifikasi PIN (misal: setelah reload atau akses pertama). Mengimpor data ini TIDAK akan memerlukan verifikasi PIN. Untuk menyertakan PIN, masuk ulang atau ubah PIN Anda terlebih dahulu.');
            }

            const dataStr = JSON.stringify(dataToExport, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `finansync_data_${new Date().toISOString().slice(0, 10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showModal('Sukses', 'Data berhasil diekspor sebagai JSON.');
        });

        // Import Data
        importFile.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = async (event) => {
                    try {
                        const importedData = JSON.parse(event.target.result);

                        // If imported data has a plaintext PIN, verify it
                        if (importedData.userProfile && importedData.userProfile.pin) {
                            const { confirmed, value: enteredPin } = await showModal(
                                'Verifikasi PIN untuk Impor Data',
                                'Data impor ini dilindungi PIN. Masukkan PIN 4 digit yang terkait dengan file JSON ini:',
                                true,
                                'PIN 4 digit',
                                'password'
                            );

                            if (confirmed && enteredPin === importedData.userProfile.pin) {
                                // Valid import PIN. Generate new hash/salt for live app storage.
                                const newSalt = generateSalt();
                                importedData.userProfile.pinHash = await hashPin(importedData.userProfile.pin, newSalt);
                                importedData.userProfile.pinSalt = newSalt;
                                // Store current plaintext PIN in session storage for later export
                                sessionStorage.setItem('currentPlaintextPin', enteredPin);
                                performImport(importedData);
                            } else {
                                showModal('Kesalahan PIN', 'PIN yang dimasukkan salah atau impor dibatalkan.');
                            }
                        } else {
                            // No plaintext PIN in imported data, proceed without PIN check
                            const { confirmed } = await showModal(
                                'Konfirmasi Impor',
                                'File impor tidak memiliki PIN. Lanjutkan tanpa verifikasi PIN? (Data Anda saat ini akan ditimpa)',
                                false
                            );
                            if (confirmed) {
                                // If the imported data didn't have a PIN, ensure the live app also doesn't set one from old appData
                                if (importedData.userProfile) {
                                    importedData.userProfile.pinHash = null;
                                    importedData.userProfile.pinSalt = null;
                                }
                                sessionStorage.removeItem('currentPlaintextPin'); // Clear session PIN
                                performImport(importedData);
                            } else {
                                showModal('Impor Dibatalkan', 'Impor data dibatalkan.');
                            }
                        }
                    } catch (error) {
                        console.error('Error importing data:', error);
                        showModal('Kesalahan Impor', 'Gagal memuat file JSON atau formatnya tidak valid.');
                    } finally {
                        e.target.value = ''; // Clear file input
                    }
                };
                reader.readAsText(file);
            }
        });

        const performImport = (importedData) => {
            // Reconstruct appData, ensuring new properties (like pinHash, pinSalt) are handled
            appData = {
                userProfile: {
                    name: importedData.userProfile?.name || 'Pengguna FinanSync',
                    initials: importedData.userProfile?.initials || 'PF',
                    theme: importedData.userProfile?.theme || 'dark',
                    profilePhotoUrl: importedData.userProfile?.profilePhotoUrl || null,
                    pinHash: importedData.userProfile?.pinHash || null, // Will be set by import logic if verified
                    pinSalt: importedData.userProfile?.pinSalt || null   // Will be set by import logic if verified
                },
                investments: importedData.investments || [],
                savingsGoals: importedData.savingsGoals || [],
                transactions: importedData.transactions || [],
                // Ensure cashSavings handles new currencies
                cashSavings: importedData.cashSavings || {}, // Initialize if missing
                goldSavings: importedData.goldSavings || 0,
                emergencyFund: {
                    target: importedData.emergencyFund?.target || 0,
                    current: importedData.emergencyFund?.current || 0
                },
                budgets: importedData.budgets || [],
                billReminders: importedData.billReminders || [],
                debts: importedData.debts || [],
                customCurrencies: importedData.customCurrencies || [] // Load custom currencies
            };

            // Ensure IDR exists in cashSavings if not present in imported data
            if (typeof appData.cashSavings.IDR === 'undefined') {
                appData.cashSavings.IDR = 0;
            }
            // Ensure all custom currencies have an entry in cashSavings
            appData.customCurrencies.forEach(currency => {
                if (typeof appData.cashSavings[currency.code] === 'undefined') {
                    appData.cashSavings[currency.code] = 0;
                }
            });

            saveAppData();
            applyTheme(appData.userProfile.theme);
            updateProfileDisplay();
            activateSection('dashboard-section'); // Go to dashboard after successful import
            showModal('Sukses', 'Data berhasil diimpor!');
        };


        // Backup Data (Simulated)
        backupDataBtn.addEventListener('click', async () => {
            const { confirmed } = await showModal('Simulasi Backup', 'Fitur backup otomatis sebenarnya membutuhkan koneksi server. Ini adalah simulasi backup lokal. Lanjutkan?');
            if (confirmed) {
                saveAppData();
                showModal('Sukses', 'Backup data disimulasikan berhasil (data disimpan ke penyimpanan lokal).');
            }
        });

        // Theme Toggle Event Listener
        themeToggle.addEventListener('change', () => {
            const newTheme = themeToggle.checked ? 'light' : 'dark';
            appData.userProfile.theme = newTheme;
            saveAppData();
            applyTheme(newTheme);
        });

        // Change PIN button in settings
        changePinButton.addEventListener('click', () => {
            currentEnteredPin = '';
            showPinScreen('change_old');
        });

        // Reset App Button
        resetAppButton.addEventListener('click', async () => {
            const { confirmed: confirmReset } = await showModal(
                'Konfirmasi Reset Aplikasi',
                'Ini akan menghapus SEMUA data aplikasi Anda secara permanen. Tindakan ini tidak dapat dibatalkan. Untuk melanjutkan, masukkan PIN Anda.',
                true,
                'PIN 4 digit',
                'password'
            );

            if (confirmReset) {
                const enteredPinForReset = modalInput.value;
                if (!appData.userProfile.pinHash || !appData.userProfile.pinSalt) {
                    // No PIN set, proceed with reset after final confirmation
                     const { confirmed: finalConfirm } = await showModal('Lanjutkan Reset?', 'Tidak ada PIN yang diatur. Apakah Anda yakin ingin mengatur ulang?', false);
                     if (finalConfirm) {
                        localStorage.clear();
                        sessionStorage.clear(); // Clear session data including plaintext PIN
                        location.reload();
                     }
                } else {
                    const hashedEnteredPin = await hashPin(enteredPinForReset, appData.userProfile.pinSalt);
                    if (hashedEnteredPin === appData.userProfile.pinHash) {
                        localStorage.clear();
                        sessionStorage.clear(); // Clear session data including plaintext PIN
                        location.reload();
                    } else {
                        showModal('PIN Salah', 'PIN yang dimasukkan salah. Reset dibatalkan.');
                    }
                }
            } else {
                showModal('Reset Dibatalkan', 'Reset aplikasi dibatalkan.');
            }
        });

        // Manage Currencies Button in Settings
        manageCurrenciesBtn.addEventListener('click', () => {
            renderCurrencyManagementModal();
            currencyModal.classList.remove('hidden');
        });

        // Close Currency Modal
        currencyModalCloseBtn.addEventListener('click', () => {
            currencyModal.classList.add('hidden');
        });

        // Render Active Currencies in Modal
        const renderActiveCurrenciesList = () => {
            activeCurrenciesList.innerHTML = '';
            // Always show IDR as fixed
            activeCurrenciesList.innerHTML += `<p class="text-current-text-secondary">IDR - Rupiah Indonesia <span class="text-current-accent-main">(Default)</span></p>`;

            appData.customCurrencies.forEach(currency => {
                const currencyItem = document.createElement('div');
                currencyItem.className = 'flex items-center justify-between py-2 px-3 bg-current-input-bg rounded-lg';
                currencyItem.innerHTML = `
                    <span class="text-current-text-primary">${currency.code} - ${currency.name} (${currency.symbol})</span>
                    <button data-code="${currency.code}" class="remove-currency-from-settings-btn status-red hover:text-status-red text-sm" aria-label="Hapus Mata Uang ${currency.name}">
                        <i class="fas fa-trash-alt mr-1"></i>Hapus
                    </button>
                `;
                activeCurrenciesList.appendChild(currencyItem);
            });
        };

        // Add New Currency Form in Modal
        addCurrencyForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const code = newCurrencyCodeInput.value.toUpperCase().trim();
            const name = newCurrencyNameInput.value.trim();
            const symbol = newCurrencySymbolInput.value.trim();

            if (!code || !name || !symbol) {
                showModal('Input Tidak Lengkap', 'Harap isi semua bidang untuk mata uang baru.');
                return;
            }

            if (appData.customCurrencies.some(c => c.code === code) || code === 'IDR') {
                showModal('Mata Uang Duplikat', `Mata uang dengan kode ${code} sudah ada atau tidak diizinkan.`);
                return;
            }

            appData.customCurrencies.push({ code, name, symbol });
            // Initialize cash savings for this new currency
            appData.cashSavings[code] = 0;
            saveAppData();
            renderActiveCurrenciesList(); // Re-render the list in the modal
            renderSavings(); // Re-render savings section to show new currency card
            addCurrencyForm.reset();
            showModal('Sukses', `Mata uang ${name} (${code}) berhasil ditambahkan.`);
        });

        // Remove Currency from Settings Modal (Event Delegation)
        activeCurrenciesList.addEventListener('click', async (e) => {
            const target = e.target.closest('.remove-currency-from-settings-btn');
            if (!target) return;

            const codeToRemove = target.dataset.code;
            if (codeToRemove === 'IDR') {
                showModal('Tidak Diizinkan', 'Mata uang default (IDR) tidak dapat dihapus.');
                return;
            }

            const { confirmed } = await showModal(
                'Konfirmasi Hapus Mata Uang',
                `Apakah Anda yakin ingin menghapus mata uang ${codeToRemove}? Semua tabungan dalam mata uang ini akan hilang.`,
                false
            );

            if (confirmed) {
                appData.customCurrencies = appData.customCurrencies.filter(c => c.code !== codeToRemove);
                delete appData.cashSavings[codeToRemove]; // Also remove the savings associated
                saveAppData();
                renderActiveCurrenciesList(); // Re-render list in modal
                renderSavings(); // Re-render savings section
                renderDashboardSummary();
                showModal('Dihapus', `Mata uang ${codeToRemove} berhasil dihapus.`);
            }
        });

        const renderCurrencyManagementModal = () => {
            renderActiveCurrenciesList();
        };


        // --- PIN Screen Logic ---

        const pinDigitDisplays = Array.from(pinInputDisplay.children); // Get digit display elements
        let pinLockoutTimer; // To store the timeout ID for lockout

        // Function to update the visual PIN display (dots or digits)
        const updatePinDisplay = () => {
            pinDigitDisplays.forEach((display, index) => {
                if (index < currentEnteredPin.length) {
                    display.classList.add('filled');
                    if (pinVisibilityHidden) {
                        display.textContent = '•'; // Use dot for hidden
                    } else {
                        display.textContent = currentEnteredPin[index]; // Show actual digit
                    }
                } else {
                    display.classList.remove('filled');
                    display.textContent = '';
                }
                // Highlight the active digit input position
                display.classList.remove('active-digit'); // Clear all active states first
                display.classList.remove('error-state'); // Clear error state on update

                if (index === currentEnteredPin.length && currentEnteredPin.length < 4) {
                    display.classList.add('active-digit');
                }
            });
             // Ensure the next available slot is active even if currentEnteredPin is empty
             if (currentEnteredPin.length < 4) {
                 pinDigitDisplays[currentEnteredPin.length].classList.add('active-digit');
             }
        };

        // Handle clicks on numeric keypad
        pinKeypad.addEventListener('click', async (e) => {
            const target = e.target.closest('button');
            if (!target || target.disabled) return; // Ignore clicks if button is disabled

            const digit = target.textContent.trim(); // Use .trim() to remove whitespace

            if (target.classList.contains('keypad-button') && !isNaN(parseInt(digit))) {
                if (currentEnteredPin.length < 4) {
                    currentEnteredPin += digit;
                    updatePinDisplay();
                    pinMessage.textContent = ''; // Clear error message on input
                }
            } else if (target.id === 'pin-clear-button') {
                currentEnteredPin = currentEnteredPin.slice(0, -1); // Remove last digit
                updatePinDisplay();
                pinMessage.textContent = '';
            } else if (target.id === 'pin-show-hide-button') {
                pinVisibilityHidden = !pinVisibilityHidden;
                pinShowHideButton.innerHTML = pinVisibilityHidden ? '<i class="fas fa-eye"></i>' : '<i class="fas fa-eye-slash"></i>';
                updatePinDisplay(); // Re-render with new visibility
            }

            // If PIN is 4 digits and action button is not clicked yet (implicit submission)
            if (currentEnteredPin.length === 4 && pinActionButton.classList.contains('animate-pulse') && (currentPinAction === 'entry' || currentPinAction === 'change_old')) {
                 pinActionButton.click();
            }
        });


        // Show/Hide PIN toggle
        pinShowHideButton.addEventListener('click', () => {
            pinVisibilityHidden = !pinVisibilityHidden;
            pinShowHideButton.innerHTML = pinVisibilityHidden ? '<i class="fas fa-eye"></i>' : '<i class="fas fa-eye-slash"></i>';
            updatePinDisplay(); // Re-render with new visibility
        });

        // Function to disable/enable keypad during lockout
        const setKeypadDisabled = (disabled) => {
            Array.from(pinKeypad.children).forEach(button => {
                button.disabled = disabled;
                if (disabled) {
                    button.classList.add('opacity-50', 'cursor-not-allowed');
                } else {
                    button.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            });
            pinActionButton.disabled = disabled;
             if (disabled) {
                pinActionButton.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                pinActionButton.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        };


        const showPinScreen = (type) => {
            pinScreen.classList.remove('hidden');
            mainAppContainer.classList.add('hidden');
            loadingOverlay.classList.add('hidden'); // Ensure loading overlay is hidden

            currentPinAction = type;
            currentEnteredPin = ''; // Clear entered PIN on screen change
            pinMessage.textContent = '';
            pinVisibilityHidden = true; // Reset to hidden on new screen
            pinShowHideButton.innerHTML = '<i class="fas fa-eye"></i>'; // Reset icon
            updatePinDisplay(); // Update visual display

            // Reset error state from dots
            pinDigitDisplays.forEach(display => display.classList.remove('error-state'));

            // Control PIN action button visibility and text
            pinActionButton.classList.remove('hidden'); // Default to visible
            pinActionButton.classList.remove('animate-pulse'); // Remove pulse animation
            forgotPinButton.classList.add('hidden'); // Default to hidden

            if (type === 'setup') {
                pinScreenTitle.textContent = 'Buat PIN 4 Digit Anda';
                pinActionButton.textContent = 'Atur PIN';
            } else if (type === 'confirm_setup') {
                pinScreenTitle.textContent = 'Konfirmasi PIN Anda';
                pinActionButton.textContent = 'Konfirmasi PIN';
            } else if (type === 'entry') {
                pinScreenTitle.textContent = 'Masukkan PIN Anda';
                pinActionButton.textContent = 'Masuk';
                forgotPinButton.classList.remove('hidden');
                pinActionButton.classList.add('animate-pulse'); // Add pulse for entry

                // Check for lockout
                if (failedPinAttempts >= MAX_FAILED_ATTEMPTS) {
                    setKeypadDisabled(true); // Disable keypad
                    pinActionButton.classList.add('hidden'); // Hide action button
                    pinMessage.textContent = `Terlalu banyak percobaan. Coba lagi dalam ${LOCKOUT_DURATION / 1000} detik.`;
                    
                    clearTimeout(pinLockoutTimer); // Clear any existing lockout timer
                    pinLockoutTimer = setTimeout(() => {
                        failedPinAttempts = 0; // Reset after lockout
                        pinMessage.textContent = '';
                        setKeypadDisabled(false); // Enable keypad
                        pinActionButton.classList.remove('hidden'); // Show action button
                        updatePinDisplay(); // Clear any error state from dots
                    }, LOCKOUT_DURATION);
                } else {
                    setKeypadDisabled(false); // Ensure keypad is enabled
                }

            } else if (type === 'change_old') {
                pinScreenTitle.textContent = 'Masukkan PIN Lama Anda';
                pinActionButton.textContent = 'Verifikasi PIN';
            } else if (type === 'change_new') {
                pinScreenTitle.textContent = 'Atur PIN Baru (4 Digit)';
                pinActionButton.textContent = 'Atur PIN Baru';
            } else if (type === 'change_confirm') {
                pinScreenTitle.textContent = 'Konfirmasi PIN Baru';
                pinActionButton.textContent = 'Konfirmasi PIN Baru';
            }
        };

        pinActionButton.addEventListener('click', async () => {
            const pin = currentEnteredPin;
            if (pin.length !== 4) {
                pinMessage.textContent = 'PIN harus 4 digit.';
                return;
            }

            if (currentPinAction === 'setup') {
                tempPin = pin;
                showPinScreen('confirm_setup');
            } else if (currentPinAction === 'confirm_setup') {
                if (pin === tempPin) {
                    const salt = generateSalt();
                    appData.userProfile.pinHash = await hashPin(pin, salt);
                    appData.userProfile.pinSalt = salt;
                    sessionStorage.setItem('currentPlaintextPin', pin); // Store plaintext in session for export
                    saveAppData();
                    await showModal('PIN Berhasil Dibuat', 'PIN Anda berhasil diatur. Selamat datang di FinanSync!');
                    initMainApp(); // Proceed to main app after modal
                } else {
                    pinMessage.textContent = 'PIN tidak cocok. Coba lagi.';
                    pinDigitDisplays.forEach(display => display.classList.add('error-state')); // Show error state on dots
                    currentEnteredPin = ''; // Clear entered PIN
                    updatePinDisplay();
                    currentPinAction = 'setup'; // Restart setup flow
                    pinScreenTitle.textContent = 'Buat PIN 4 Digit Anda';
                    pinActionButton.textContent = 'Atur PIN';
                }
            } else if (currentPinAction === 'entry') {
                const storedHash = appData.userProfile.pinHash;
                const storedSalt = appData.userProfile.pinSalt;
                const enteredHash = await hashPin(pin, storedSalt);

                if (enteredHash === storedHash) {
                    failedPinAttempts = 0; // Reset attempts on success
                    sessionStorage.setItem('currentPlaintextPin', pin); // Store plaintext in session for export
                    initMainApp(); // Proceed to main app
                } else {
                    failedPinAttempts++;
                    pinMessage.textContent = `PIN salah. Anda memiliki ${MAX_FAILED_ATTEMPTS - failedPinAttempts} percobaan tersisa.`;
                    pinDigitDisplays.forEach(display => display.classList.add('error-state')); // Show error state on dots
                    currentEnteredPin = '';
                    updatePinDisplay();

                    if (failedPinAttempts >= MAX_FAILED_ATTEMPTS) {
                        showPinScreen('entry'); // Trigger lockout
                    }
                }
            } else if (currentPinAction === 'change_old') {
                const storedHash = appData.userProfile.pinHash;
                const storedSalt = appData.userProfile.pinSalt;
                const enteredHash = await hashPin(pin, storedSalt);

                if (enteredHash === storedHash) {
                    tempPin = ''; // Clear any previous temp PIN
                    showPinScreen('change_new');
                } else {
                    pinMessage.textContent = 'PIN lama salah.';
                    pinDigitDisplays.forEach(display => display.classList.add('error-state')); // Show error state on dots
                    currentEnteredPin = '';
                    updatePinDisplay();
                }
            } else if (currentPinAction === 'change_new') {
                tempPin = pin;
                showPinScreen('change_confirm');
            } else if (currentPinAction === 'change_confirm') {
                if (pin === tempPin) {
                    const salt = generateSalt();
                    appData.userProfile.pinHash = await hashPin(pin, salt);
                    appData.userProfile.pinSalt = salt;
                    sessionStorage.setItem('currentPlaintextPin', pin); // Update session plaintext PIN
                    saveAppData();
                    await showModal('PIN Berhasil Diubah', 'PIN Anda berhasil diperbarui!');
                    pinScreen.classList.add('hidden');
                    mainAppContainer.classList.remove('hidden');
                } else {
                    pinMessage.textContent = 'Konfirmasi PIN tidak cocok. Coba lagi.';
                    pinDigitDisplays.forEach(display => display.classList.add('error-state')); // Show error state on dots
                    currentEnteredPin = ''; // Clear entered PIN
                    updatePinDisplay();
                    showPinScreen('change_new'); // Restart new PIN flow
                }
            }
        });

        forgotPinButton.addEventListener('click', async () => {
            const { confirmed } = await showModal(
                'Lupa PIN?',
                'Jika Anda lupa PIN, semua data lokal Anda akan dihapus secara permanen dan aplikasi akan diatur ulang. Lanjutkan?',
                false
            );
            if (confirmed) {
                localStorage.clear(); // Clear all data
                sessionStorage.clear(); // Clear session data including plaintext PIN
                location.reload(); // Reload the app
            }
        });

        // --- Initialization and Main App Flow ---

        /**
         * Initializes the main application UI and logic.
         * Only called after successful PIN authentication.
         */
        const initMainApp = () => {
            pinScreen.classList.add('hidden');
            mainAppContainer.classList.remove('hidden');
            resetInactivityTimer(); // Start inactivity timer

            // Apply number formatting to all relevant input fields
            document.querySelectorAll('input[type="number"]').forEach(input => {
                let maxDecimals = 2; // Default for currency
                if (input.id === 'asset-amount' || input.id === 'asset-price-per-unit') {
                    maxDecimals = 8; // High precision for crypto units/prices
                } else if (input.id === 'annual-rate' || input.id === 'debt-interest-rate' || input.id === 'estimated-return') {
                     maxDecimals = 4; // Percentage rates
                }
                applyCurrencyInputFormatting(input, maxDecimals);
            });

            // Set current date for transaction and bill forms
            document.getElementById('transaction-date').valueAsDate = new Date();
            document.getElementById('bill-due-date').valueAsDate = new Date();
            const today = new Date();
            const currentMonth = today.getFullYear() + '-' + (today.getMonth() + 1).toString().padStart(2, '0');
            document.getElementById('budget-month').value = currentMonth;

            // Trigger initial state for crypto fields in investment section
            assetTypeSelect.dispatchEvent(new Event('change'));

            activateSection('dashboard-section'); // Show initial dashboard

            // Initial margin setting for main content on desktop
            if (window.innerWidth >= 768) {
                mainContent.classList.add('sidebar-collapsed-margin');
            }

            // Dismiss loading overlay after main app is ready
            loadingOverlay.style.opacity = '0';
            setTimeout(() => loadingOverlay.classList.add('hidden'), 500);
        };


        /**
         * The overall application initialization flow, including PIN.
         */
        const appInitFlow = () => {
            loadAppData(); // Attempt to load existing data and PIN

            if (appData.userProfile.pinHash) { // Check for pinHash instead of pin
                showPinScreen('entry'); // If PIN exists, prompt for entry
            } else {
                showPinScreen('setup'); // If no PIN, prompt to set up
            }
            // Apply initial theme settings from appData
            applyTheme(appData.userProfile.theme);
            updateProfileDisplay(); // Update profile display once data is loaded
        };

        window.onload = appInitFlow;

        // Dynamic adjustment of main content margin based on sidebar state
        window.addEventListener('resize', () => {
            if (window.innerWidth >= 768) { // Desktop
                if (sidebar.classList.contains('md:hover:w-64') && sidebar.matches(':hover')) {
                     mainContent.classList.remove('sidebar-collapsed-margin');
                     mainContent.classList.add('sidebar-expanded-margin');
                } else {
                     mainContent.classList.remove('sidebar-expanded-margin');
                     mainContent.classList.add('sidebar-collapsed-margin');
                }
            } else { // Mobile
                mainContent.classList.remove('sidebar-expanded-margin', 'sidebar-collapsed-margin');
            }
        });

    </script>
</body>
</html>
